/**
 * BDDS Dashboard - Financial Dashboard
 *
 * Unified script file for GitHub Pages deployment
 * Combines all modules: utilities, components, and main dashboard
 *
 * @version 1.0.0
 * @author BDDS Team
 */

(function () {
  "use strict";

  // ============================================================================
  // 1. UTILITIES - formatNumber.js CHART_CONFIG_DEFAULTS
  // ============================================================================

  /**
   * Format a number with space as thousand separator
   * @param {number} value - The number to format
   * @returns {string} Formatted number string (e.g., "1 366 339")
   */
  function formatNumber(value) {
    if (value === null || value === undefined) {
      return "-";
    }
    if (isNaN(value)) {
      return "0";
    }

    const absValue = Math.abs(value);
    const formatted = new Intl.NumberFormat("ru-RU", {
      useGrouping: true,
      maximumFractionDigits: 0,
    }).format(absValue);

    const withRegularSpace = formatted.replace(/\u00A0/g, " ");
    return value < 0 ? `-${withRegularSpace}` : withRegularSpace;
  }

  /**
   * Format a number with delta percentage
   */
  function formatWithDelta(value, delta) {
    const formattedValue = formatNumber(value);
    if (delta === null) {
      return { value: formattedValue, delta: null };
    }
    const deltaStr = `(${Math.round(delta)}%)`;
    return { value: formattedValue, delta: deltaStr };
  }

  /**
   * Format a number for chart display (short format)
   */
  function formatShort(value) {
    if (value === null || value === undefined || isNaN(value)) {
      return "0";
    }
    return Math.round(value).toString();
  }

  // ============================================================================
  // 1.1 DATA UTILITIES (from generateData.js)
  // ============================================================================

  /**
   * All metric keys used in the dashboard
   */
  var METRIC_KEYS = {
    // Operational Activity Section
    OPERATION_MOVEMENT: "Движение Д/С по операционной деятельности ООО",
    OPERATION_INCOME: "Поступления по операционной деятельности",
    OPERATION_EXPENSE: "Расходы по основной деятельности",
    OPERATION_DEPOSITS: "Обеспечительные платежи",

    // Investment Activity Section
    INVESTMENT_MOVEMENT: "Движение Д/С по инвестиционной деятельности",
    INVESTMENT_DIVIDENDS: "Выплата дохода акционерам (пайщикам)",
    INVESTMENT_REPAIRS: "Расходы на капитальный ремонт",

    // Financial Activity Section
    FINANCE_MOVEMENT: "Движение Д/С по финансовой деятельности",
    FINANCE_CREDITS: "Расчеты по кредитам",
    FINANCE_OTHER: "Прочие доходы и расходы по финансовой деятельности",
    FINANCE_PARUS: "Расходы на УК Парус",

    // Credit Balance Block
    CREDIT_START: "Остаток по кредиту на начало периода",
    CREDIT_END: "Остаток по кредиту на конец периода",

    // Cash Movement Section
    CASH_MOVEMENT: "Движение за период по Д/С",
    RESERVES_FORMED: "Сформированные резервы (нарастающим итогом)",
    RESERVES_ACCUMULATED:
      "Накопленные резервы на ремонт, непредвиденные расходы и вакансию",

    // Cash Balance Block
    CASH_START: "Остаток Д/С на начало периода",
    CASH_END: "Остаток Д/С на конец периода",
    CASH_WITH_RESERVE: "Д/С на конец периода (с учетом резерва)",
  };

  /**
   * Calculate delta between two periods
   * @param {number} currentValue - Current period value
   * @param {number} previousValue - Previous period value
   * @returns {number} Delta percentage
   */
  function calculateDelta(currentValue, previousValue) {
    if (currentValue === null || previousValue === null) {
      return null;
    }
    if (previousValue === 0) {
      return currentValue === 0 ? 0 : 100;
    }
    return Math.round(
      ((currentValue - previousValue) / Math.abs(previousValue)) * 100
    );
  }

  /**
   * Parse period string to extract type and year
   * @param {string} periodString - Period label (e.g., "Факт '23", "План '26")
   * @returns {Object} { type: 'fact'|'plan'|'mixed', year: number }
   */
  function parsePeriodInfo(periodString) {
    var hasFact = /факт/i.test(periodString);
    var hasPlan = /план/i.test(periodString);

    var type = "fact";
    if (hasFact && hasPlan) {
      type = "mixed";
    } else if (hasPlan) {
      type = "plan";
    }

    // Extract year from patterns like '23, '24, '25, '26
    var yearMatch = periodString.match(/'(\d{2})/);
    var year = new Date().getFullYear();
    if (yearMatch) {
      year = 2000 + parseInt(yearMatch[1], 10);
    }

    return { type: type, year: year };
  }

  /**
   * Default periods configuration (for fallback/testing)
   */
  var DEFAULT_PERIODS = [
    { year: 2023, type: "fact", label: "Факт '23" },
    { year: 2024, type: "fact", label: "Факт '24" },
    {
      year: 2025,
      type: "mixed",
      label: "Факт (I-III кв. '25)\nПлан (IV кв. '25)",
    },
    { year: 2026, type: "plan", label: "План '26" },
  ];

  /**
   * Default chart configuration
   */
  var DEFAULT_CHART_CONFIG = {
    title: "Выплата дохода акционерам (пайщикам), млн ₽",
    metric: METRIC_KEYS.INVESTMENT_DIVIDENDS,
    unit: "млн ₽",
    scale: {
      min: 0,
      max: 1500,
      step: 300,
    },
    colors: {
      fact: "#9DBCE0",
      plan: "#D9D9D9",
    },
  };

  /**
   * Default data for dashboard (used when window.DATA is not provided)
   */
  var DEFAULT_DATA = {
    currentFund: "ДВН",
    viewMode: "details",
    funds: {
      ДВН: {
        type: "building",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 5,
            "Поступления по операционной деятельности": 23,
            "Расходы по основной деятельности": -456,
            "Обеспечительные платежи": 7890,
            "Движение Д/С по инвестиционной деятельности": -8,
            "Выплата дохода акционерам (пайщикам)": -150,
            "Расходы на капитальный ремонт": 34,
            "Движение Д/С по финансовой деятельности": -567,
            "Расчеты по кредитам": 1234,
            "Прочие доходы и расходы по финансовой деятельности": 9,
            "Расходы на УК Парус": -78,
            "Остаток по кредиту на начало периода": 345,
            "Остаток по кредиту на конец периода": -6789,
            "Движение за период по Д/С": 3,
            "Сформированные резервы (нарастающим итогом)": 56,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -890,
            "Остаток Д/С на начало периода": 4321,
            "Остаток Д/С на конец периода": 7,
            "Д/С на конец периода (с учетом резерва)": 89
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 7,
            "Поступления по операционной деятельности": 31,
            "Расходы по основной деятельности": -512,
            "Обеспечительные платежи": 8234,
            "Движение Д/С по инвестиционной деятельности": -6,
            "Выплата дохода акционерам (пайщикам)": -480,
            "Расходы на капитальный ремонт": 41,
            "Движение Д/С по финансовой деятельности": -623,
            "Расчеты по кредитам": 1456,
            "Прочие доходы и расходы по финансовой деятельности": 7,
            "Расходы на УК Парус": -89,
            "Остаток по кредиту на начало периода": 412,
            "Остаток по кредиту на конец периода": -7123,
            "Движение за период по Д/С": 4,
            "Сформированные резервы (нарастающим итогом)": 67,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -945,
            "Остаток Д/С на начало периода": 4567,
            "Остаток Д/С на конец периода": 5,
            "Д/С на конец периода (с учетом резерва)": 78
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 6,
            "Поступления по операционной деятельности": 28,
            "Расходы по основной деятельности": -489,
            "Обеспечительные платежи": 7456,
            "Движение Д/С по инвестиционной деятельности": -9,
            "Выплата дохода акционерам (пайщикам)": -920,
            "Расходы на капитальный ремонт": 38,
            "Движение Д/С по финансовой деятельности": -598,
            "Расчеты по кредитам": 1345,
            "Прочие доходы и расходы по финансовой деятельности": 8,
            "Расходы на УК Парус": -82,
            "Остаток по кредиту на начало периода": 389,
            "Остаток по кредиту на конец периода": -6945,
            "Движение за период по Д/С": 5,
            "Сформированные резервы (нарастающим итогом)": 62,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -912,
            "Остаток Д/С на начало периода": 4234,
            "Остаток Д/С на конец периода": 6,
            "Д/С на конец периода (с учетом резерва)": 95
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 8,
            "Поступления по операционной деятельности": 35,
            "Расходы по основной деятельности": -534,
            "Обеспечительные платежи": 8567,
            "Движение Д/С по инвестиционной деятельности": -7,
            "Выплата дохода акционерам (пайщикам)": -1350,
            "Расходы на капитальный ремонт": 45,
            "Движение Д/С по финансовой деятельности": -645,
            "Расчеты по кредитам": 1567,
            "Прочие доходы и расходы по финансовой деятельности": 6,
            "Расходы на УК Парус": -95,
            "Остаток по кредиту на начало периода": 456,
            "Остаток по кредиту на конец периода": -7456,
            "Движение за период по Д/С": 2,
            "Сформированные резервы (нарастающим итогом)": 71,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -978,
            "Остаток Д/С на начало периода": 4789,
            "Остаток Д/С на конец периода": 9,
            "Д/С на конец периода (с учетом резерва)": 67
          }
        }
      },
      ЗОЛЯ: {
        type: "warehouse",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 78,
            "Поступления по операционной деятельности": 45,
            "Расходы по основной деятельности": -567,
            "Обеспечительные платежи": 1234,
            "Движение Д/С по инвестиционной деятельности": -9,
            "Выплата дохода акционерам (пайщикам)": -220,
            "Расходы на капитальный ремонт": 890,
            "Движение Д/С по финансовой деятельности": -67,
            "Расчеты по кредитам": 2345,
            "Прочие доходы и расходы по финансовой деятельности": 78,
            "Расходы на УК Парус": -5,
            "Остаток по кредиту на начало периода": 901,
            "Остаток по кредиту на конец периода": -3456,
            "Движение за период по Д/С": 12,
            "Сформированные резервы (нарастающим итогом)": 67,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -8901,
            "Остаток Д/С на начало периода": 456,
            "Остаток Д/С на конец периода": 23,
            "Д/С на конец периода (с учетом резерва)": 456
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 85,
            "Поступления по операционной деятельности": 52,
            "Расходы по основной деятельности": -612,
            "Обеспечительные платежи": 1378,
            "Движение Д/С по инвестиционной деятельности": -7,
            "Выплата дохода акционерам (пайщикам)": -560,
            "Расходы на капитальный ремонт": 945,
            "Движение Д/С по финансовой деятельности": -72,
            "Расчеты по кредитам": 2567,
            "Прочие доходы и расходы по финансовой деятельности": 85,
            "Расходы на УК Парус": -6,
            "Остаток по кредиту на начало периода": 978,
            "Остаток по кредиту на конец периода": -3678,
            "Движение за период по Д/С": 15,
            "Сформированные резервы (нарастающим итогом)": 74,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -9234,
            "Остаток Д/С на начало периода": 489,
            "Остаток Д/С на конец периода": 28,
            "Д/С на конец периода (с учетом резерва)": 512
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 82,
            "Поступления по операционной деятельности": 48,
            "Расходы по основной деятельности": -589,
            "Обеспечительные платежи": 1312,
            "Движение Д/С по инвестиционной деятельности": -8,
            "Выплата дохода акционерам (пайщикам)": -780,
            "Расходы на капитальный ремонт": 912,
            "Движение Д/С по финансовой деятельности": -69,
            "Расчеты по кредитам": 2456,
            "Прочие доходы и расходы по финансовой деятельности": 81,
            "Расходы на УК Парус": -4,
            "Остаток по кредиту на начало периода": 945,
            "Остаток по кредиту на конец периода": -3567,
            "Движение за период по Д/С": 14,
            "Сформированные резервы (нарастающим итогом)": 71,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -9067,
            "Остаток Д/С на начало периода": 478,
            "Остаток Д/С на конец периода": 26,
            "Д/С на конец периода (с учетом резерва)": 489
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 91,
            "Поступления по операционной деятельности": 56,
            "Расходы по основной деятельности": -634,
            "Обеспечительные платежи": 1456,
            "Движение Д/С по инвестиционной деятельности": -6,
            "Выплата дохода акционерам (пайщикам)": -1100,
            "Расходы на капитальный ремонт": 978,
            "Движение Д/С по финансовой деятельности": -74,
            "Расчеты по кредитам": 2678,
            "Прочие доходы и расходы по финансовой деятельности": 92,
            "Расходы на УК Парус": -7,
            "Остаток по кредиту на начало периода": 1012,
            "Остаток по кредиту на конец периода": -3789,
            "Движение за период по Д/С": 18,
            "Сформированные резервы (нарастающим итогом)": 79,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -9456,
            "Остаток Д/С на начало периода": 512,
            "Остаток Д/С на конец периода": 31,
            "Д/С на конец периода (с учетом резерва)": 534
          }
        }
      },
      КРАС: {
        type: "warehouse",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 345,
            "Поступления по операционной деятельности": 67,
            "Расходы по основной деятельности": -89,
            "Обеспечительные платежи": 7890,
            "Движение Д/С по инвестиционной деятельности": -2,
            "Выплата дохода акционерам (пайщикам)": -310,
            "Расходы на капитальный ремонт": 1234,
            "Движение Д/С по финансовой деятельности": -78,
            "Расчеты по кредитам": 9,
            "Прочие доходы и расходы по финансовой деятельности": 345,
            "Расходы на УК Парус": -6789,
            "Остаток по кредиту на начало периода": 4,
            "Остаток по кредиту на конец периода": -23,
            "Движение за период по Д/С": 890,
            "Сформированные резервы (нарастающим итогом)": -5678,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 1,
            "Остаток Д/С на начало периода": -67,
            "Остаток Д/С на конец периода": 234,
            "Д/С на конец периода (с учетом резерва)": -9012
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 378,
            "Поступления по операционной деятельности": 74,
            "Расходы по основной деятельности": -95,
            "Обеспечительные платежи": 8234,
            "Движение Д/С по инвестиционной деятельности": -3,
            "Выплата дохода акционерам (пайщикам)": -620,
            "Расходы на капитальный ремонт": 1345,
            "Движение Д/С по финансовой деятельности": -85,
            "Расчеты по кредитам": 7,
            "Прочие доходы и расходы по финансовой деятельности": 378,
            "Расходы на УК Парус": -7123,
            "Остаток по кредиту на начало периода": 5,
            "Остаток по кредиту на конец периода": -28,
            "Движение за период по Д/С": 945,
            "Сформированные резервы (нарастающим итогом)": -5912,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 2,
            "Остаток Д/С на начало периода": -72,
            "Остаток Д/С на конец периода": 256,
            "Д/С на конец периода (с учетом резерва)": -9345
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 362,
            "Поступления по операционной деятельности": 71,
            "Расходы по основной деятельности": -92,
            "Обеспечительные платежи": 8067,
            "Движение Д/С по инвестиционной деятельности": -1,
            "Выплата дохода акционерам (пайщикам)": -850,
            "Расходы на капитальный ремонт": 1289,
            "Движение Д/С по финансовой деятельности": -81,
            "Расчеты по кредитам": 8,
            "Прочие доходы и расходы по финансовой деятельности": 362,
            "Расходы на УК Парус": -6956,
            "Остаток по кредиту на начало периода": 3,
            "Остаток по кредиту на конец периода": -25,
            "Движение за период по Д/С": 917,
            "Сформированные резервы (нарастающим итогом)": -5789,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 3,
            "Остаток Д/С на начало периода": -69,
            "Остаток Д/С на конец периода": 245,
            "Д/С на конец периода (с учетом резерва)": -9178
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 389,
            "Поступления по операционной деятельности": 78,
            "Расходы по основной деятельности": -98,
            "Обеспечительные платежи": 8456,
            "Движение Д/С по инвестиционной деятельности": -4,
            "Выплата дохода акционерам (пайщикам)": -1200,
            "Расходы на капитальный ремонт": 1378,
            "Движение Д/С по финансовой деятельности": -89,
            "Расчеты по кредитам": 6,
            "Прочие доходы и расходы по финансовой деятельности": 389,
            "Расходы на УК Парус": -7289,
            "Остаток по кредиту на начало периода": 6,
            "Остаток по кредиту на конец периода": -31,
            "Движение за период по Д/С": 978,
            "Сформированные резервы (нарастающим итогом)": -6012,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 4,
            "Остаток Д/С на начало периода": -75,
            "Остаток Д/С на конец периода": 267,
            "Д/С на конец периода (с учетом резерва)": -9512
          }
        }
      },
      ЛОГ: {
        type: "warehouse",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 6,
            "Поступления по операционной деятельности": 789,
            "Расходы по основной деятельности": -23,
            "Обеспечительные платежи": 4567,
            "Движение Д/С по инвестиционной деятельности": -890,
            "Выплата дохода акционерам (пайщикам)": -9,
            "Расходы на капитальный ремонт": 45,
            "Движение Д/С по финансовой деятельности": 1234,
            "Расчеты по кредитам": -78,
            "Прочие доходы и расходы по финансовой деятельности": 5,
            "Расходы на УК Парус": -901,
            "Остаток по кредиту на начало периода": 34,
            "Остаток по кредиту на конец периода": -6789,
            "Движение за период по Д/С": 2,
            "Сформированные резервы (нарастающим итогом)": -56,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 8901,
            "Остаток Д/С на начало периода": -12,
            "Остаток Д/С на конец периода": 678,
            "Д/С на конец периода (с учетом резерва)": -3
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 7,
            "Поступления по операционной деятельности": 845,
            "Расходы по основной деятельности": -28,
            "Обеспечительные платежи": 4789,
            "Движение Д/С по инвестиционной деятельности": -923,
            "Выплата дохода акционерам (пайщикам)": -8,
            "Расходы на капитальный ремонт": 51,
            "Движение Д/С по финансовой деятельности": 1345,
            "Расчеты по кредитам": -85,
            "Прочие доходы и расходы по финансовой деятельности": 6,
            "Расходы на УК Парус": -956,
            "Остаток по кредиту на начало периода": 39,
            "Остаток по кредиту на конец периода": -7123,
            "Движение за период по Д/С": 3,
            "Сформированные резервы (нарастающим итогом)": -62,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 9234,
            "Остаток Д/С на начало периода": -15,
            "Остаток Д/С на конец периода": 712,
            "Д/С на конец периода (с учетом резерва)": -4
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 5,
            "Поступления по операционной деятельности": 812,
            "Расходы по основной деятельности": -25,
            "Обеспечительные платежи": 4678,
            "Движение Д/С по инвестиционной деятельности": -912,
            "Выплата дохода акционерам (пайщикам)": -7,
            "Расходы на капитальный ремонт": 48,
            "Движение Д/С по финансовой деятельности": 1289,
            "Расчеты по кредитам": -81,
            "Прочие доходы и расходы по финансовой деятельности": 4,
            "Расходы на УК Парус": -934,
            "Остаток по кредиту на начало периода": 37,
            "Остаток по кредиту на конец периода": -6956,
            "Движение за период по Д/С": 1,
            "Сформированные резервы (нарастающим итогом)": -59,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 9067,
            "Остаток Д/С на начало периода": -14,
            "Остаток Д/С на конец периода": 695,
            "Д/С на конец периода (с учетом резерва)": -2
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 8,
            "Поступления по операционной деятельности": 867,
            "Расходы по основной деятельности": -31,
            "Обеспечительные платежи": 4912,
            "Движение Д/С по инвестиционной деятельности": -956,
            "Выплата дохода акционерам (пайщикам)": -6,
            "Расходы на капитальный ремонт": 54,
            "Движение Д/С по финансовой деятельности": 1378,
            "Расчеты по кредитам": -89,
            "Прочие доходы и расходы по финансовой деятельности": 7,
            "Расходы на УК Парус": -978,
            "Остаток по кредиту на начало периода": 41,
            "Остаток по кредиту на конец периода": -7289,
            "Движение за период по Д/С": 4,
            "Сформированные резервы (нарастающим итогом)": -65,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": 9456,
            "Остаток Д/С на начало периода": -17,
            "Остаток Д/С на конец периода": 734,
            "Д/С на конец периода (с учетом резерва)": -5
          }
        }
      },
      НОР: {
        type: "warehouse",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 456,
            "Поступления по операционной деятельности": 678,
            "Расходы по основной деятельности": -234,
            "Обеспечительные платежи": -56,
            "Движение Д/С по инвестиционной деятельности": 89,
            "Выплата дохода акционерам (пайщикам)": -34,
            "Расходы на капитальный ремонт": 567,
            "Движение Д/С по финансовой деятельности": -123,
            "Расчеты по кредитам": 2345,
            "Прочие доходы и расходы по финансовой деятельности": -78,
            "Расходы на УК Парус": 45,
            "Остаток по кредиту на начало периода": -890,
            "Остаток по кредиту на конец периода": 1234,
            "Движение за период по Д/С": -345,
            "Сформированные резервы (нарастающим итогом)": 67,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -456,
            "Остаток Д/С на начало периода": 789,
            "Остаток Д/С на конец периода": -123,
            "Д/С на конец периода (с учетом резерва)": 56
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 512,
            "Поступления по операционной деятельности": 745,
            "Расходы по основной деятельности": -289,
            "Обеспечительные платежи": -67,
            "Движение Д/С по инвестиционной деятельности": 102,
            "Выплата дохода акционерам (пайщикам)": -41,
            "Расходы на капитальный ремонт": 623,
            "Движение Д/С по финансовой деятельности": -156,
            "Расчеты по кредитам": 2678,
            "Прочие доходы и расходы по финансовой деятельности": -92,
            "Расходы на УК Парус": 52,
            "Остаток по кредиту на начало периода": -945,
            "Остаток по кредиту на конец периода": 1389,
            "Движение за период по Д/С": -412,
            "Сформированные резервы (нарастающим итогом)": 78,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -523,
            "Остаток Д/С на начало периода": 856,
            "Остаток Д/С на конец периода": -145,
            "Д/С на конец периода (с учетом резерва)": 63
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 489,
            "Поступления по операционной деятельности": 712,
            "Расходы по основной деятельности": -256,
            "Обеспечительные платежи": -61,
            "Движение Д/С по инвестиционной деятельности": 95,
            "Выплата дохода акционерам (пайщикам)": -38,
            "Расходы на капитальный ремонт": 589,
            "Движение Д/С по финансовой деятельности": -139,
            "Расчеты по кредитам": 2512,
            "Прочие доходы и расходы по финансовой деятельности": -85,
            "Расходы на УК Парус": 48,
            "Остаток по кредиту на начало периода": -912,
            "Остаток по кредиту на конец периода": 1312,
            "Движение за период по Д/С": -378,
            "Сформированные резервы (нарастающим итогом)": 72,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -489,
            "Остаток Д/С на начало периода": 823,
            "Остаток Д/С на конец периода": -134,
            "Д/С на конец периода (с учетом резерва)": 59
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 534,
            "Поступления по операционной деятельности": 789,
            "Расходы по основной деятельности": -312,
            "Обеспечительные платежи": -73,
            "Движение Д/С по инвестиционной деятельности": 108,
            "Выплата дохода акционерам (пайщикам)": -45,
            "Расходы на капитальный ремонт": 645,
            "Движение Д/С по финансовой деятельности": -167,
            "Расчеты по кредитам": 2845,
            "Прочие доходы и расходы по финансовой деятельности": -98,
            "Расходы на УК Парус": 56,
            "Остаток по кредиту на начало периода": -978,
            "Остаток по кредиту на конец периода": 1456,
            "Движение за период по Д/С": -423,
            "Сформированные резервы (нарастающим итогом)": 84,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -534,
            "Остаток Д/С на начало периода": 912,
            "Остаток Д/С на конец периода": -156,
            "Д/С на конец периода (с учетом резерва)": 67
          }
        }
      },
      ОЗН: {
        type: "warehouse",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 1234,
            "Поступления по операционной деятельности": 2345,
            "Расходы по основной деятельности": -456,
            "Обеспечительные платежи": -123,
            "Движение Д/С по инвестиционной деятельности": 67,
            "Выплата дохода акционерам (пайщикам)": -89,
            "Расходы на капитальный ремонт": 345,
            "Движение Д/С по финансовой деятельности": -567,
            "Расчеты по кредитам": 890,
            "Прочие доходы и расходы по финансовой деятельности": -34,
            "Расходы на УК Парус": 78,
            "Остаток по кредиту на начало периода": -1567,
            "Остаток по кредиту на конец периода": 2345,
            "Движение за период по Д/С": -234,
            "Сформированные резервы (нарастающим итогом)": 456,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -789,
            "Остаток Д/С на начало периода": 123,
            "Остаток Д/С на конец периода": -56,
            "Д/С на конец периода (с учетом резерва)": 678
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 1389,
            "Поступления по операционной деятельности": 2567,
            "Расходы по основной деятельности": -512,
            "Обеспечительные платежи": -145,
            "Движение Д/С по инвестиционной деятельности": 78,
            "Выплата дохода акционерам (пайщикам)": -102,
            "Расходы на капитальный ремонт": 389,
            "Движение Д/С по финансовой деятельности": -623,
            "Расчеты по кредитам": 956,
            "Прочие доходы и расходы по финансовой деятельности": -41,
            "Расходы на УК Парус": 89,
            "Остаток по кредиту на начало периода": -1678,
            "Остаток по кредиту на конец периода": 2512,
            "Движение за период по Д/С": -278,
            "Сформированные резервы (нарастающим итогом)": 512,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -845,
            "Остаток Д/С на начало периода": 145,
            "Остаток Д/С на конец периода": -63,
            "Д/С на конец периода (с учетом резерва)": 734
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 1312,
            "Поступления по операционной деятельности": 2456,
            "Расходы по основной деятельности": -489,
            "Обеспечительные платежи": -134,
            "Движение Д/С по инвестиционной деятельности": 72,
            "Выплата дохода акционерам (пайщикам)": -95,
            "Расходы на капитальный ремонт": 367,
            "Движение Д/С по финансовой деятельности": -589,
            "Расчеты по кредитам": 923,
            "Прочие доходы и расходы по финансовой деятельности": -38,
            "Расходы на УК Парус": 84,
            "Остаток по кредиту на начало периода": -1623,
            "Остаток по кредиту на конец периода": 2423,
            "Движение за период по Д/С": -256,
            "Сформированные резервы (нарастающим итогом)": 489,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -812,
            "Остаток Д/С на начало периода": 134,
            "Остаток Д/С на конец периода": -59,
            "Д/С на конец периода (с учетом резерва)": 701
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 1456,
            "Поступления по операционной деятельности": 2678,
            "Расходы по основной деятельности": -534,
            "Обеспечительные платежи": -156,
            "Движение Д/С по инвестиционной деятельности": 84,
            "Выплата дохода акционерам (пайщикам)": -108,
            "Расходы на капитальный ремонт": 412,
            "Движение Д/С по финансовой деятельности": -645,
            "Расчеты по кредитам": 989,
            "Прочие доходы и расходы по финансовой деятельности": -45,
            "Расходы на УК Парус": 92,
            "Остаток по кредиту на начало периода": -1734,
            "Остаток по кредиту на конец периода": 2589,
            "Движение за период по Д/С": -289,
            "Сформированные резервы (нарастающим итогом)": 534,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -867,
            "Остаток Д/С на начало периода": 156,
            "Остаток Д/С на конец периода": -67,
            "Д/С на конец периода (с учетом резерва)": 756
          }
        }
      },
      ТРМ: {
        type: "briefcase",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 78,
            "Поступления по операционной деятельности": 156,
            "Расходы по основной деятельности": -34,
            "Обеспечительные платежи": -567,
            "Движение Д/С по инвестиционной деятельности": 23,
            "Выплата дохода акционерам (пайщикам)": -45,
            "Расходы на капитальный ремонт": 234,
            "Движение Д/С по финансовой деятельности": -89,
            "Расчеты по кредитам": 456,
            "Прочие доходы и расходы по финансовой деятельности": -12,
            "Расходы на УК Парус": 678,
            "Остаток по кредиту на начало периода": -345,
            "Остаток по кредиту на конец периода": 789,
            "Движение за период по Д/С": -56,
            "Сформированные резервы (нарастающим итогом)": 123,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -234,
            "Остаток Д/С на начало периода": 456,
            "Остаток Д/С на конец периода": -78,
            "Д/С на конец периода (с учетом резерва)": 345
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 89,
            "Поступления по операционной деятельности": 178,
            "Расходы по основной деятельности": -41,
            "Обеспечительные платежи": -612,
            "Движение Д/С по инвестиционной деятельности": 28,
            "Выплата дохода акционерам (пайщикам)": -52,
            "Расходы на капитальный ремонт": 267,
            "Движение Д/С по финансовой деятельности": -102,
            "Расчеты по кредитам": 512,
            "Прочие доходы и расходы по финансовой деятельности": -15,
            "Расходы на УК Парус": 734,
            "Остаток по кредиту на начало периода": -389,
            "Остаток по кредиту на конец периода": 845,
            "Движение за период по Д/С": -63,
            "Сформированные резервы (нарастающим итогом)": 145,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -278,
            "Остаток Д/С на начало периода": 512,
            "Остаток Д/С на конец периода": -89,
            "Д/С на конец периода (с учетом резерва)": 389
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 84,
            "Поступления по операционной деятельности": 167,
            "Расходы по основной деятельности": -38,
            "Обеспечительные платежи": -589,
            "Движение Д/С по инвестиционной деятельности": 25,
            "Выплата дохода акционерам (пайщикам)": -48,
            "Расходы на капитальный ремонт": 251,
            "Движение Д/С по финансовой деятельности": -95,
            "Расчеты по кредитам": 489,
            "Прочие доходы и расходы по финансовой деятельности": -13,
            "Расходы на УК Парус": 712,
            "Остаток по кредиту на начало периода": -367,
            "Остаток по кредиту на конец периода": 812,
            "Движение за период по Д/С": -59,
            "Сформированные резервы (нарастающим итогом)": 134,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -256,
            "Остаток Д/С на начало периода": 489,
            "Остаток Д/С на конец периода": -84,
            "Д/С на конец периода (с учетом резерва)": 367
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 95,
            "Поступления по операционной деятельности": 189,
            "Расходы по основной деятельности": -45,
            "Обеспечительные платежи": -645,
            "Движение Д/С по инвестиционной деятельности": 31,
            "Выплата дохода акционерам (пайщикам)": -56,
            "Расходы на капитальный ремонт": 289,
            "Движение Д/С по финансовой деятельности": -108,
            "Расчеты по кредитам": 534,
            "Прочие доходы и расходы по финансовой деятельности": -17,
            "Расходы на УК Парус": 778,
            "Остаток по кредиту на начало периода": -412,
            "Остаток по кредиту на конец периода": 889,
            "Движение за период по Д/С": -67,
            "Сформированные резервы (нарастающим итогом)": 156,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -289,
            "Остаток Д/С на начало периода": 534,
            "Остаток Д/С на конец периода": -95,
            "Д/С на конец периода (с учетом резерва)": 412
          }
        }
      },
      СБЛ: {
        type: "warehouse",
        periods: {
          "Факт '23": {
            "Движение Д/С по операционной деятельности ООО": 3456,
            "Поступления по операционной деятельности": 4567,
            "Расходы по основной деятельности": -1234,
            "Обеспечительные платежи": -345,
            "Движение Д/С по инвестиционной деятельности": 89,
            "Выплата дохода акционерам (пайщикам)": -234,
            "Расходы на капитальный ремонт": 567,
            "Движение Д/С по финансовой деятельности": -789,
            "Расчеты по кредитам": 123,
            "Прочие доходы и расходы по финансовой деятельности": -45,
            "Расходы на УК Парус": 234,
            "Остаток по кредиту на начало периода": -567,
            "Остаток по кредиту на конец периода": 890,
            "Движение за период по Д/С": -123,
            "Сформированные резервы (нарастающим итогом)": 345,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -678,
            "Остаток Д/С на начало периода": 456,
            "Остаток Д/С на конец периода": -89,
            "Д/С на конец периода (с учетом резерва)": 234
          },
          "Факт '24": {
            "Движение Д/С по операционной деятельности ООО": 3789,
            "Поступления по операционной деятельности": 4912,
            "Расходы по основной деятельности": -1389,
            "Обеспечительные платежи": -389,
            "Движение Д/С по инвестиционной деятельности": 102,
            "Выплата дохода акционерам (пайщикам)": -267,
            "Расходы на капитальный ремонт": 623,
            "Движение Д/С по финансовой деятельности": -845,
            "Расчеты по кредитам": 145,
            "Прочие доходы и расходы по финансовой деятельности": -52,
            "Расходы на УК Парус": 267,
            "Остаток по кредиту на начало периода": -612,
            "Остаток по кредиту на конец периода": 956,
            "Движение за период по Д/С": -145,
            "Сформированные резервы (нарастающим итогом)": 389,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -734,
            "Остаток Д/С на начало периода": 512,
            "Остаток Д/С на конец периода": -102,
            "Д/С на конец периода (с учетом резерва)": 267
          },
          "Факт (I-III кв. '25)\nПлан (IV кв. '25)": {
            "Движение Д/С по операционной деятельности ООО": 3623,
            "Поступления по операционной деятельности": 4734,
            "Расходы по основной деятельности": -1312,
            "Обеспечительные платежи": -367,
            "Движение Д/С по инвестиционной деятельности": 95,
            "Выплата дохода акционерам (пайщикам)": -251,
            "Расходы на капитальный ремонт": 589,
            "Движение Д/С по финансовой деятельности": -812,
            "Расчеты по кредитам": 134,
            "Прочие доходы и расходы по финансовой деятельности": -48,
            "Расходы на УК Парус": 251,
            "Остаток по кредиту на начало периода": -589,
            "Остаток по кредиту на конец периода": 923,
            "Движение за период по Д/С": -134,
            "Сформированные резервы (нарастающим итогом)": 367,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -712,
            "Остаток Д/С на начало периода": 489,
            "Остаток Д/С на конец периода": -95,
            "Д/С на конец периода (с учетом резерва)": 251
          },
          "План '26": {
            "Движение Д/С по операционной деятельности ООО": 3912,
            "Поступления по операционной деятельности": 5089,
            "Расходы по основной деятельности": -1456,
            "Обеспечительные платежи": -412,
            "Движение Д/С по инвестиционной деятельности": 108,
            "Выплата дохода акционерам (пайщикам)": -289,
            "Расходы на капитальный ремонт": 656,
            "Движение Д/С по финансовой деятельности": -878,
            "Расчеты по кредитам": 156,
            "Прочие доходы и расходы по финансовой деятельности": -56,
            "Расходы на УК Парус": 289,
            "Остаток по кредиту на начало периода": -645,
            "Остаток по кредиту на конец периода": 989,
            "Движение за период по Д/С": -156,
            "Сформированные резервы (нарастающим итогом)": 412,
            "Накопленные резервы на ремонт, непредвиденные расходы и вакансию": -778,
            "Остаток Д/С на начало периода": 534,
            "Остаток Д/С на конец периода": -108,
            "Д/С на конец периода (с учетом резерва)": 289
          }
        }
      }
    },
    periods: DEFAULT_PERIODS,
    chartConfig: DEFAULT_CHART_CONFIG
  };

  // ============================================================================
  // 2. UTILITIES - dom.js
  // ============================================================================

  function $(selector, context) {
    return (context || document).querySelector(selector);
  }

  function $$(selector, context) {
    return (context || document).querySelectorAll(selector);
  }

  function createElement(tag, className, content, attrs) {
    className = className || "";
    content = content || "";
    attrs = attrs || {};

    const element = document.createElement(tag);

    if (className) {
      if (Array.isArray(className)) {
        element.classList.add.apply(
          element.classList,
          className.filter(Boolean)
        );
      } else {
        element.className = className;
      }
    }

    if (content) {
      if (typeof content === "string") {
        element.textContent = content;
      } else if (Array.isArray(content)) {
        content.forEach(function (child) {
          if (child) element.appendChild(child);
        });
      } else if (content instanceof Element) {
        element.appendChild(content);
      }
    }

    Object.entries(attrs).forEach(function (entry) {
      var key = entry[0];
      var value = entry[1];
      if (key === "data") {
        Object.entries(value).forEach(function (dataEntry) {
          element.dataset[dataEntry[0]] = dataEntry[1];
        });
      } else if (key === "style" && typeof value === "object") {
        Object.assign(element.style, value);
      } else if (key.startsWith("on") && typeof value === "function") {
        var event = key.slice(2).toLowerCase();
        element.addEventListener(event, value);
      } else {
        element.setAttribute(key, value);
      }
    });

    return element;
  }

  var SVG_NS = "http://www.w3.org/2000/svg";

  function createSVGElement(tag, attrs) {
    attrs = attrs || {};
    var element = document.createElementNS(SVG_NS, tag);

    Object.entries(attrs).forEach(function (entry) {
      if (entry[1] !== undefined && entry[1] !== null) {
        element.setAttribute(entry[0], entry[1]);
      }
    });

    return element;
  }

  function createSVG(width, height, className) {
    var svg = createSVGElement("svg", {
      viewBox: "0 0 " + width + " " + height,
      class: className || "",
      preserveAspectRatio: "xMidYMid meet",
    });
    return svg;
  }

  function createSVGText(text, x, y, attrs) {
    var textElement = createSVGElement(
      "text",
      Object.assign({ x: x, y: y }, attrs || {})
    );
    textElement.textContent = text;
    return textElement;
  }

  function createSVGRect(x, y, width, height, attrs) {
    return createSVGElement(
      "rect",
      Object.assign({ x: x, y: y, width: width, height: height }, attrs || {})
    );
  }

  function createSVGRoundedTopRect(x, y, width, height, radius, attrs) {
    var r = Math.min(radius, height / 2, width / 2);
    var d =
      "M" + x + "," + (y + height) +
      " L" + x + "," + (y + r) +
      " A" + r + "," + r + " 0 0,1 " + (x + r) + "," + y +
      " L" + (x + width - r) + "," + y +
      " A" + r + "," + r + " 0 0,1 " + (x + width) + "," + (y + r) +
      " L" + (x + width) + "," + (y + height) +
      " Z";
    return createSVGElement(
      "path",
      Object.assign({ d: d }, attrs || {})
    );
  }

  function createSVGLine(x1, y1, x2, y2, attrs) {
    return createSVGElement(
      "line",
      Object.assign({ x1: x1, y1: y1, x2: x2, y2: y2 }, attrs || {})
    );
  }

  function createSVGGroup(className, children) {
    var group = createSVGElement("g", { class: className || "" });
    (children || []).forEach(function (child) {
      if (child) group.appendChild(child);
    });
    return group;
  }

  function clearElement(element) {
    while (element.firstChild) {
      element.removeChild(element.firstChild);
    }
  }

  /**
   * Calculate chart scale based on max value
   * Always produces exactly 5 divisions on the scale
   * @param {number} maxValue - maximum data value
   * @returns {{min: number, max: number, step: number}}
   */
  function calculateChartScale(maxValue) {
    var DIVISIONS = 5;

    if (maxValue <= 0) {
      return { min: 0, max: 100, step: 20 };
    }

    // Find nice round number for max that divides evenly by 5
    var magnitude = Math.pow(10, Math.floor(Math.log10(maxValue)));
    var normalized = maxValue / magnitude;

    // Choose ceiling that gives nice step when divided by 5
    // Only use multipliers that result in round step values
    // 1->200, 1.5->300, 2->400, 2.5->500, 5->1000, 10->2000
    var niceMultipliers = [1, 1.5, 2, 2.5, 5, 10];
    var niceMax = magnitude * 10;
    for (var i = 0; i < niceMultipliers.length; i++) {
      if (normalized <= niceMultipliers[i]) {
        niceMax = magnitude * niceMultipliers[i];
        break;
      }
    }

    // Step is exactly max / 5 for consistent 5 divisions
    var step = niceMax / DIVISIONS;

    return { min: 0, max: niceMax, step: step };
  }

  // ============================================================================
  // 3. COMPONENTS - HighlightBlock.js
  // ============================================================================

  function renderHighlightBlock(rows, periodData, viewMode) {
    var blockEl = createElement("div", "highlight-block");

    rows.forEach(function (row) {
      var rowEl = renderHighlightRow(row, periodData, viewMode);
      blockEl.appendChild(rowEl);
    });

    return blockEl;
  }

  function renderHighlightRow(row, periodData, viewMode) {
    var rowEl = createElement("div", "table-row");

    var labelEl = createElement("span", "table-row__label");
    if (row.multiline) {
      var lines = row.label.split("\n");
      labelEl.innerHTML = lines.join("<br>");
    } else {
      labelEl.textContent = row.label;
    }
    rowEl.appendChild(labelEl);

    var valuesEl = createElement("div", "table-row__values");

    if (viewMode === "details") {
      periodData.forEach(function (period) {
        var value = period.metrics[row.key];
        var valueEl = createElement("span", "table-row__value");

        if (period.type === "mixed") {
          valueEl.classList.add("table-row__value--wide");
        }

        valueEl.textContent = formatNumber(value);
        valuesEl.appendChild(valueEl);
      });
    } else {
      // Dynamics mode: first period vs last period
      var firstPeriod = periodData[0];
      var lastPeriod = periodData[periodData.length - 1];
      var isSinglePeriod = periodData.length === 1;

      var value1 = firstPeriod ? firstPeriod.metrics[row.key] : null;
      var valueEl1 = createElement("span", "table-row__value");
      valueEl1.textContent = formatNumber(value1);
      valuesEl.appendChild(valueEl1);

      // If single period, show same value; otherwise show last period
      var value2 = isSinglePeriod
        ? value1
        : lastPeriod
        ? lastPeriod.metrics[row.key]
        : null;
      var valueEl2 = createElement(
        "span",
        "table-row__value table-row__value--wide"
      );
      valueEl2.textContent = formatNumber(value2);
      valuesEl.appendChild(valueEl2);

      // Delta: 0 if same period, otherwise calculate
      var delta = isSinglePeriod ? 0 : calculateDelta(value2, value1);
      var formatted = formatWithDelta(value2, delta);
      var deltaEl = createElement("span", "table-row__value");
      deltaEl.textContent = formatted.value;
      if (formatted.delta !== null) {
        var deltaSpan = createElement("span", "table-row__delta");
        deltaSpan.textContent = formatted.delta;
        deltaEl.appendChild(deltaSpan);
      }
      valuesEl.appendChild(deltaEl);
    }

    rowEl.appendChild(valuesEl);
    return rowEl;
  }

  // ============================================================================
  // 4. COMPONENTS - TableSection.js
  // ============================================================================

  var SECTIONS = {
    operation: {
      id: "operation",
      title: "Операционная часть",
      cssClass: "table-section--operation",
      rows: [
        {
          id: "op-movement",
          key: METRIC_KEYS.OPERATION_MOVEMENT,
          label: "Движение Д/С по операционной деятельности ООО",
          isHeader: true,
        },
        {
          id: "op-income",
          key: METRIC_KEYS.OPERATION_INCOME,
          label: "Поступления по операционной деятельности",
          isHeader: false,
        },
        {
          id: "op-expense",
          key: METRIC_KEYS.OPERATION_EXPENSE,
          label: "Расходы по основной деятельности",
          isHeader: false,
        },
        {
          id: "op-deposits",
          key: METRIC_KEYS.OPERATION_DEPOSITS,
          label: "Обеспечительные платежи",
          isHeader: false,
        },
      ],
    },
    investment: {
      id: "investment",
      title: "Инвестиционная часть",
      cssClass: "table-section--investment",
      rows: [
        {
          id: "inv-movement",
          key: METRIC_KEYS.INVESTMENT_MOVEMENT,
          label: "Движение Д/С по инвестиционной деятельности",
          isHeader: true,
        },
        {
          id: "inv-dividends",
          key: METRIC_KEYS.INVESTMENT_DIVIDENDS,
          label: "Выплата дохода акционерам (пайщикам)",
          isHeader: false,
        },
        {
          id: "inv-repairs",
          key: METRIC_KEYS.INVESTMENT_REPAIRS,
          label: "Расходы на капитальный ремонт",
          isHeader: false,
        },
      ],
    },
    finance: {
      id: "finance",
      title: "Финансовая часть",
      cssClass: "table-section--finance",
      rows: [
        {
          id: "fin-movement",
          key: METRIC_KEYS.FINANCE_MOVEMENT,
          label: "Движение Д/С по финансовой деятельности",
          isHeader: true,
        },
        {
          id: "fin-credits",
          key: METRIC_KEYS.FINANCE_CREDITS,
          label: "Расчеты по кредитам",
          isHeader: false,
        },
        {
          id: "fin-other",
          key: METRIC_KEYS.FINANCE_OTHER,
          label: "Прочие доходы и расходы\nпо финансовой деятельности",
          isHeader: false,
          multiline: true,
        },
        {
          id: "fin-parus",
          key: METRIC_KEYS.FINANCE_PARUS,
          label: "Расходы на УК Парус",
          isHeader: false,
        },
      ],
    },
  };

  var CREDIT_BALANCE_ROWS = [
    {
      id: "credit-start",
      key: METRIC_KEYS.CREDIT_START,
      label: "Остаток по кредиту на начало периода",
      isHeader: true,
    },
    {
      id: "credit-end",
      key: METRIC_KEYS.CREDIT_END,
      label: "Остаток по кредиту на конец периода",
      isHeader: true,
    },
  ];

  var CASH_MOVEMENT_ROWS = [
    {
      id: "cash-movement",
      key: METRIC_KEYS.CASH_MOVEMENT,
      label: "Движение за период по Д/С",
      isHeader: true,
    },
    {
      id: "reserves-formed",
      key: METRIC_KEYS.RESERVES_FORMED,
      label: "Сформированные резервы (нарастающим итогом)",
      isHeader: false,
    },
    {
      id: "reserves-accumulated",
      key: METRIC_KEYS.RESERVES_ACCUMULATED,
      label:
        "Накопленные резервы на ремонт,\nнепредвиденные расходы и вакансию",
      isHeader: false,
      multiline: true,
    },
  ];

  var CASH_BALANCE_ROWS = [
    {
      id: "cash-start",
      key: METRIC_KEYS.CASH_START,
      label: "Остаток Д/С на начало периода",
      isHeader: true,
    },
    {
      id: "cash-end",
      key: METRIC_KEYS.CASH_END,
      label: "Остаток Д/С на конец периода",
      isHeader: true,
    },
    {
      id: "cash-reserve",
      key: METRIC_KEYS.CASH_WITH_RESERVE,
      label: "Д/С на конец периода (с учетом резерва)",
      isHeader: true,
    },
  ];

  function renderTableRow(row, periodData, viewMode) {
    var rowClasses = ["table-row"];
    if (row.isHeader) rowClasses.push("table-row--header");

    var rowEl = createElement("div", rowClasses.join(" "));

    var labelEl = createElement("span", "table-row__label");
    if (row.multiline) {
      var lines = row.label.split("\n");
      labelEl.innerHTML = lines.join("<br>");
    } else {
      labelEl.textContent = row.label;
    }
    rowEl.appendChild(labelEl);

    var valuesEl = createElement("div", "table-row__values");

    if (viewMode === "details") {
      periodData.forEach(function (period) {
        var value = period.metrics[row.key];
        var valueEl = createElement("span", "table-row__value");

        if (period.type === "mixed") {
          valueEl.classList.add("table-row__value--wide");
        }

        valueEl.textContent = formatNumber(value);
        valuesEl.appendChild(valueEl);
      });
    } else {
      // Dynamics mode: first period vs last period
      var firstPeriod = periodData[0];
      var lastPeriod = periodData[periodData.length - 1];
      var isSinglePeriod = periodData.length === 1;

      var value1 = firstPeriod ? firstPeriod.metrics[row.key] : null;
      var valueEl1 = createElement("span", "table-row__value");
      valueEl1.textContent = formatNumber(value1);
      valuesEl.appendChild(valueEl1);

      // If single period, show same value; otherwise show last period
      var value2 = isSinglePeriod
        ? value1
        : lastPeriod
        ? lastPeriod.metrics[row.key]
        : null;
      var valueEl2 = createElement(
        "span",
        "table-row__value table-row__value--wide"
      );
      valueEl2.textContent = formatNumber(value2);
      valuesEl.appendChild(valueEl2);

      // Delta: 0 if same period, otherwise calculate
      var delta = isSinglePeriod ? 0 : calculateDelta(value2, value1);
      var formatted = formatWithDelta(value2, delta);
      var deltaEl = createElement("span", "table-row__value");
      deltaEl.textContent = formatted.value;
      if (formatted.delta !== null) {
        var deltaSpan = createElement("span", "table-row__delta");
        deltaSpan.textContent = formatted.delta;
        deltaEl.appendChild(deltaSpan);
      }
      valuesEl.appendChild(deltaEl);
    }

    rowEl.appendChild(valuesEl);
    return rowEl;
  }

  function renderTableSection(section, periodData, viewMode, periods) {
    var sectionEl = createElement(
      "section",
      "table-section " + section.cssClass
    );

    var titleEl = createElement("h2", "table-section__title", section.title);
    sectionEl.appendChild(titleEl);

    // Column headers for mobile (hidden on desktop via CSS)
    if (periodData && periodData.length > 0) {
      var columnHeaders = renderTableHeaders(periodData, viewMode);
      columnHeaders.classList.add("table-section__headers");
      sectionEl.appendChild(columnHeaders);
    }

    var contentEl = createElement("div", "table-section__content");

    section.rows.forEach(function (row) {
      var rowEl = renderTableRow(row, periodData, viewMode);
      contentEl.appendChild(rowEl);
    });

    sectionEl.appendChild(contentEl);
    return sectionEl;
  }

  function renderTableHeaders(periodData, viewMode) {
    var container = createElement("div", "table-header__columns");

    if (viewMode === "details") {
      periodData.forEach(function (period) {
        var headerEl = createElement("span", "table-header__column");

        if (period.type === "mixed") {
          headerEl.classList.add("table-header__column--wide");
          var lines = period.title.split("\n");
          headerEl.innerHTML = lines.join("<br>");
        } else {
          headerEl.textContent = period.title;
        }

        container.appendChild(headerEl);
      });
    } else {
      // Dynamics mode: first period, last period, delta
      var firstPeriod = periodData[0];
      var lastPeriod = periodData[periodData.length - 1];
      var isSinglePeriod = periodData.length === 1;

      var headers = [
        {
          label: firstPeriod ? firstPeriod.title : "-",
          wide: firstPeriod && firstPeriod.type === "mixed",
        },
        {
          label: isSinglePeriod
            ? firstPeriod.title
            : lastPeriod
            ? lastPeriod.title
            : "-",
          wide: lastPeriod && lastPeriod.type === "mixed",
        },
        { label: "Дельта", wide: false },
      ];

      headers.forEach(function (header) {
        var headerEl = createElement("span", "table-header__column");
        if (header.wide) {
          headerEl.classList.add("table-header__column--wide");
          var lines = header.label.split("\n");
          headerEl.innerHTML = lines.join("<br>");
        } else {
          headerEl.textContent = header.label;
        }
        container.appendChild(headerEl);
      });
    }

    return container;
  }

  function renderAllTableSections(periodData, viewMode, periods) {
    var fragment = document.createDocumentFragment();

    fragment.appendChild(
      renderTableSection(SECTIONS.operation, periodData, viewMode, periods)
    );
    fragment.appendChild(
      renderTableSection(SECTIONS.investment, periodData, viewMode, periods)
    );

    // Finance section (includes credit balance, cash movement, cash balance)
    var financeSection = createElement(
      "section",
      "table-section table-section--finance"
    );

    // Title with colored background
    var financeTitleEl = createElement(
      "h2",
      "table-section__title",
      SECTIONS.finance.title
    );
    financeSection.appendChild(financeTitleEl);

    // Column headers for mobile (hidden on desktop via CSS)
    if (periodData && periodData.length > 0) {
      var columnHeaders = renderTableHeaders(periodData, viewMode);
      columnHeaders.classList.add("table-section__headers");
      financeSection.appendChild(columnHeaders);
    }

    // Content container with border
    var financeContentEl = createElement("div", "table-section__content");

    // Finance rows
    SECTIONS.finance.rows.forEach(function (row) {
      financeContentEl.appendChild(renderTableRow(row, periodData, viewMode));
    });

    // Credit balance highlight block (inside finance section)
    financeContentEl.appendChild(
      renderHighlightBlock(CREDIT_BALANCE_ROWS, periodData, viewMode)
    );

    // Cash movement rows
    CASH_MOVEMENT_ROWS.forEach(function (row) {
      financeContentEl.appendChild(renderTableRow(row, periodData, viewMode));
    });

    // Cash balance highlight block (inside finance section)
    financeContentEl.appendChild(
      renderHighlightBlock(CASH_BALANCE_ROWS, periodData, viewMode)
    );

    financeSection.appendChild(financeContentEl);
    fragment.appendChild(financeSection);

    return fragment;
  }

  // ============================================================================
  // 5. COMPONENTS - BarChart.js
  // ============================================================================

  // Mobile detection helper
  function isMobile() {
    return window.innerWidth < 768;
  }

  // Desktop chart config
  var CHART_CONFIG_DESKTOP = {
    viewBoxWidth: 300,
    viewBoxHeight: 520,
    chartLeft: 50,
    chartRight: 290,
    chartTop: 20,
    chartBottom: 480,
    barWidth: 50,
    barGap: 12,
    barRadius: 5,
    yAxisLabelX: 40,
    xAxisLabelY: 505,
  };

  // Mobile chart config (per Figma spec)
  var CHART_CONFIG_MOBILE = {
    viewBoxWidth: 260,
    viewBoxHeight: 360,
    chartLeft: 40,
    chartRight: 250,
    chartTop: 15,
    chartBottom: 320,
    barWidth: 34,
    barGap: 8,
    barRadius: 4,
    yAxisLabelX: 35,
    xAxisLabelY: 345,
  };

  // Get chart config based on viewport
  function getChartConfig() {
    return isMobile() ? CHART_CONFIG_MOBILE : CHART_CONFIG_DESKTOP;
  }

  function calculateBarHeight(value, scale, maxPixelHeight) {
    var min = scale.min;
    var max = scale.max;
    var range = max - min;

    if (range === 0) return 0;

    var normalized = (value - min) / range;
    return Math.max(0, normalized * maxPixelHeight);
  }

  function generateYAxisLabels(scale, chartTop, chartBottom) {
    var labels = [];
    var min = scale.min;
    var max = scale.max;
    var step = scale.step;
    var chartHeight = chartBottom - chartTop;
    var range = max - min;

    for (var value = max; value >= min; value -= step) {
      if (value === 0) continue;
      var normalized = (max - value) / range;
      var y = chartTop + normalized * chartHeight;
      labels.push({ value: value, y: y + 4 });
    }

    return labels;
  }

  function generateGridLines(
    scale,
    chartTop,
    chartBottom,
    chartLeft,
    chartRight
  ) {
    var lines = [];
    var min = scale.min;
    var max = scale.max;
    var step = scale.step;
    var chartHeight = chartBottom - chartTop;
    var range = max - min;

    for (var value = max; value >= min; value -= step) {
      var normalized = (max - value) / range;
      var y = chartTop + normalized * chartHeight;
      lines.push({ y: y, x1: chartLeft, x2: chartRight });
    }

    lines.push({ y: chartBottom, x1: chartLeft, x2: chartRight });

    return lines;
  }

  function renderBarChart(config, data) {
    var scale = config.scale || { min: 100, max: 1000, step: 100 };
    var customValues = config.customValues || null;
    var colors = config.colors || { fact: "#9DBCE0", plan: "#D9D9D9" };

    // Use responsive chart config based on viewport
    var chartLayout = getChartConfig();

    var viewBoxWidth = chartLayout.viewBoxWidth;
    var viewBoxHeight = chartLayout.viewBoxHeight;
    var chartLeft = chartLayout.chartLeft;
    var chartRight = chartLayout.chartRight;
    var chartTop = chartLayout.chartTop;
    var chartBottom = chartLayout.chartBottom;
    var barWidth = chartLayout.barWidth;
    var barGap = chartLayout.barGap;
    var barRadius = chartLayout.barRadius;
    var yAxisLabelX = chartLayout.yAxisLabelX;
    var xAxisLabelY = chartLayout.xAxisLabelY;

    var chartHeight = chartBottom - chartTop;
    var chartWidth = chartRight - chartLeft;

    var totalBarsWidth = data.length * barWidth + (data.length - 1) * barGap;
    var barsStartX = chartLeft + (chartWidth - totalBarsWidth) / 2;

    var svg = createSVG(viewBoxWidth, viewBoxHeight, "chart__svg");
    svg.setAttribute("role", "img");
    svg.setAttribute(
      "aria-label",
      "Bar chart showing dividend payments by year"
    );

    var titleEl = createSVGElement("title");
    titleEl.textContent = config.title || "Dividend Chart";
    svg.appendChild(titleEl);

    // Y-axis labels
    var yAxisGroup = createSVGGroup("chart__y-axis");
    var yLabels = generateYAxisLabels(scale, chartTop, chartBottom);

    yLabels.forEach(function (label) {
      var text = createSVGText(
        formatNumber(label.value),
        yAxisLabelX,
        label.y,
        { "text-anchor": "end" }
      );
      yAxisGroup.appendChild(text);
    });
    svg.appendChild(yAxisGroup);

    // Grid lines
    var gridGroup = createSVGGroup("chart__grid");
    var gridLines = generateGridLines(
      scale,
      chartTop,
      chartBottom,
      chartLeft,
      chartRight
    );

    gridLines.forEach(function (line) {
      var lineEl = createSVGLine(line.x1, line.y, line.x2, line.y);
      gridGroup.appendChild(lineEl);
    });
    svg.appendChild(gridGroup);

    // Bars
    var barsGroup = createSVGGroup("chart__bars");

    data.forEach(function (item, index) {
      var value =
        customValues && customValues[index] !== undefined
          ? customValues[index]
          : item.value;

      var height = calculateBarHeight(value, scale, chartHeight);
      var x = barsStartX + index * (barWidth + barGap);
      var y = chartBottom - height;

      var actualFill = index < 2 ? colors.fact : colors.plan;

      var rect = createSVGRoundedTopRect(x, y, barWidth, height, barRadius, {
        fill: actualFill,
        class: "chart__bar chart__bar--" + (index < 2 ? "fact" : "plan"),
      });

      rect.setAttribute("aria-label", item.label + ": " + value);

      barsGroup.appendChild(rect);
    });
    svg.appendChild(barsGroup);

    // Value labels
    var valuesGroup = createSVGGroup("chart__values");

    data.forEach(function (item, index) {
      var value =
        customValues && customValues[index] !== undefined
          ? customValues[index]
          : item.value;

      var height = calculateBarHeight(value, scale, chartHeight);
      var x = barsStartX + index * (barWidth + barGap) + barWidth / 2;
      var y = chartBottom - height - 8;

      var text = createSVGText(formatShort(value), x, y, {
        "text-anchor": "middle",
      });
      valuesGroup.appendChild(text);
    });
    svg.appendChild(valuesGroup);

    // X-axis labels
    var xAxisGroup = createSVGGroup("chart__x-axis");

    data.forEach(function (item, index) {
      var x = barsStartX + index * (barWidth + barGap) + barWidth / 2;

      var text = createSVGText(item.label, x, xAxisLabelY, {
        "text-anchor": "middle",
      });
      xAxisGroup.appendChild(text);
    });
    svg.appendChild(xAxisGroup);

    return svg;
  }

  // ============================================================================
  // 6. COMPONENTS - FundSelector.js
  // ============================================================================

  var FUND_ICONS = {
    warehouse:
      '<svg viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 10V19H3V10L11 4L19 10Z" fill="#A9DB21"/><rect x="5" y="12" width="4" height="5" fill="white"/><rect x="13" y="12" width="4" height="5" fill="white"/></svg>',
    building:
      '<svg viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 3H13V19H4V3Z" fill="#9DBCE0"/><path d="M13 8H18V19H13V8Z" fill="#9DBCE0"/><rect x="6" y="5" width="2" height="2" fill="white"/><rect x="9" y="5" width="2" height="2" fill="white"/><rect x="6" y="9" width="2" height="2" fill="white"/><rect x="9" y="9" width="2" height="2" fill="white"/><rect x="6" y="13" width="2" height="2" fill="white"/><rect x="9" y="13" width="2" height="2" fill="white"/><rect x="14" y="10" width="2" height="2" fill="white"/><rect x="14" y="14" width="2" height="2" fill="white"/></svg>',
    briefcase:
      '<svg viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="16" height="11" rx="1" fill="#C7A4C0"/><path d="M8 7V5C8 4.44772 8.44772 4 9 4H13C13.5523 4 14 4.44772 14 5V7" stroke="#C7A4C0" stroke-width="2"/><rect x="10" y="10" width="2" height="4" fill="white"/></svg>',
  };

  // Цвета для каждого типа фонда (соответствуют цветам в иконках)
  var FUND_COLORS = {
    warehouse: {
      primary: "#A9DB21",
      sectionHeader: "rgba(169, 219, 33, 0.41)",
      chartFact: "#A9DB21",
    },
    building: {
      primary: "#9DBCE0",
      sectionHeader: "rgba(157, 188, 224, 0.41)",
      chartFact: "#9DBCE0",
    },
    briefcase: {
      primary: "#C7A4C0",
      sectionHeader: "rgba(199, 164, 192, 0.41)",
      chartFact: "#C7A4C0",
    },
  };

  var DEFAULT_ICON_TYPE = "building";

  /**
   * FundsService - централизованный сервис работы с фондами
   * Все данные о фондах приходят из window.DATA.funds
   */
  var FundsService = {
    _rawData: null,

    /**
     * Инициализация с данными
     * @param {Object} rawData - { funds: { fundName: { type, periods: {...} } }, currentFund?, viewMode? }
     */
    init: function (rawData) {
      this._rawData = rawData;
      return this;
    },

    /**
     * Получить список фондов из данных
     * @returns {Array<string>}
     */
    getFundsList: function () {
      if (!this._rawData || !this._rawData.funds) return [];
      return Object.keys(this._rawData.funds);
    },

    /**
     * Получить дефолтный фонд
     * @returns {string|null}
     */
    getDefaultFund: function () {
      if (this._rawData && this._rawData.currentFund) {
        return this._rawData.currentFund;
      }
      var funds = this.getFundsList();
      return funds.length > 0 ? funds[0] : null;
    },

    /**
     * Получить тип иконки фонда из данных
     * @param {string} fundName
     * @returns {string}
     */
    getFundType: function (fundName) {
      if (this._rawData && this._rawData.funds && this._rawData.funds[fundName]) {
        return this._rawData.funds[fundName].type || DEFAULT_ICON_TYPE;
      }
      return DEFAULT_ICON_TYPE;
    },

    /**
     * Получить SVG иконку для фонда
     * @param {string} fundName
     * @returns {string}
     */
    getIcon: function (fundName) {
      var type = this.getFundType(fundName);
      return FUND_ICONS[type] || FUND_ICONS[DEFAULT_ICON_TYPE];
    },

    /**
     * Получить цвета для фонда
     * @param {string} fundName
     * @returns {Object} { primary, sectionHeader, chartFact }
     */
    getColors: function (fundName) {
      var type = this.getFundType(fundName);
      return FUND_COLORS[type] || FUND_COLORS[DEFAULT_ICON_TYPE];
    },

    /**
     * Получить группы фондов для UI (по типу иконки)
     * @returns {Array<{icon: string, funds: string[]}>}
     */
    getGroups: function () {
      var self = this;
      var groups = {};
      this.getFundsList().forEach(function (fund) {
        var type = self.getFundType(fund);
        if (!groups[type]) {
          groups[type] = { icon: type, funds: [] };
        }
        groups[type].funds.push(fund);
      });
      return Object.keys(groups).map(function (key) {
        return groups[key];
      });
    },

    /**
     * Получить периоды фонда
     * @param {string} fundName
     * @returns {Object}
     */
    getPeriods: function (fundName) {
      if (this._rawData && this._rawData.funds && this._rawData.funds[fundName]) {
        return this._rawData.funds[fundName].periods || {};
      }
      return {};
    },

    /**
     * Получить список названий периодов для фонда
     * @param {string} fundName
     * @returns {Array<string>} - ["Факт '23", "Факт '24", ...]
     */
    getPeriodsList: function (fundName) {
      return Object.keys(this.getPeriods(fundName));
    },

    /**
     * Получить все доступные фонды с их периодами
     * @returns {Object} - { "ДВН": ["Факт '23", ...], "ЗОЛЯ": [...] }
     */
    getAllFundsWithPeriods: function () {
      var self = this;
      var result = {};
      this.getFundsList().forEach(function (fund) {
        result[fund] = self.getPeriodsList(fund);
      });
      return result;
    },

    /**
     * Получить данные в формате для Dashboard (массив периодов)
     * @param {string} fundName
     * @returns {Array}
     */
    getDashboardData: function (fundName) {
      var periods = this.getPeriods(fundName);
      var result = Object.keys(periods).map(function (label, index) {
        var info = parsePeriodInfo(label);
        return {
          id: "period-" + index,
          title: label,
          type: info.type,
          year: info.year,
          metrics: periods[label],
        };
      });
      // Сортировка по году
      result.sort(function (a, b) {
        return a.year - b.year;
      });
      return result;
    },
  };

  /**
   * Преобразует сырые данные бэкенда в формат дашборда
   *
   * ИНСТРУКЦИЯ: Замените логику внутри этой функции под формат вашего бэкенда.
   * Функция должна возвращать объект в формате:
   * {
   *   funds: {
   *     "НазваниеФонда": {
   *       type: "building" | "warehouse" | "briefcase",
   *       periods: {
   *         "Факт '24": {
   *           "Название метрики": числовое_значение
   *         }
   *       }
   *     }
   *   },
   *   currentFund: "НазваниеФонда",  // опционально
   *   viewMode: "details"            // опционально: "details" | "dynamics"
   * }
   *
   * @param {Object} rawData - Сырые данные с бэкенда (любой формат)
   * @returns {Object} - Данные в формате дашборда
   */
  function processRawData(rawData) {
    // Если данные уже в формате дашборда — возвращаем как есть
    if (rawData && rawData.funds) {
      return rawData;
    }

    // =========================================================================
    // TODO: Замените код ниже на вашу логику преобразования
    // =========================================================================

    // Пример: если бэкенд отдаёт массив объектов
    // rawData = [
    //   { name: "ДВН", category: "office", data: { "2024": { income: 100 } } },
    //   { name: "ЗОЛЯ", category: "warehouse", data: { "2024": { income: 200 } } }
    // ]

    if (Array.isArray(rawData)) {
      var funds = {};
      rawData.forEach(function(item) {
        var fundName = item.name || item.fund_name || "Unknown";
        var type = "building";
        if (item.category === "warehouse" || item.type === "warehouse") {
          type = "warehouse";
        } else if (item.category === "briefcase" || item.type === "briefcase") {
          type = "briefcase";
        }

        var periods = {};
        var periodsData = item.periods || item.data || {};
        Object.keys(periodsData).forEach(function(periodKey) {
          periods[periodKey] = periodsData[periodKey];
        });

        funds[fundName] = {
          type: type,
          periods: periods
        };
      });

      return { funds: funds };
    }

    // Если формат не распознан — возвращаем пустой объект
    console.warn("processRawData: неизвестный формат данных", rawData);
    return { funds: {} };
  }

  // Обратная совместимость
  function getFundIcon(fundName) {
    return FundsService.getIcon(fundName);
  }

  var FundSelector = {
    state: {
      isOpen: false,
      selected: null,
      funds: [],
      onChange: null,
      initialized: false,
    },
    elements: {
      container: null,
      trigger: null,
      value: null,
      dropdown: null,
      grid: null,
    },

    init: function (options) {
      options = options || {};
      // Используем FundsService для получения списка фондов и дефолтного выбора
      this.state.selected = options.selected || FundsService.getDefaultFund();
      this.state.funds = options.funds || FundsService.getFundsList();
      this.state.onChange = options.onChange || function () {};

      this.elements.container = $("#fundSelector");
      this.elements.trigger = $(
        ".fund-selector__trigger",
        this.elements.container
      );
      this.elements.value = $("#fundSelectorValue");
      this.elements.dropdown = $("#fundDropdown");
      this.elements.grid = $("#fundGrid");

      if (!this.elements.container) {
        console.error("FundSelector: Container element not found");
        return;
      }

      this.render();
      // Only attach events once
      if (!this.state.initialized) {
        this.attachEvents();
        this.state.initialized = true;
      }
    },

    buildDynamicGroups: function () {
      // Используем FundsService для получения групп по типам иконок
      return FundsService.getGroups();
    },

    render: function () {
      var self = this;
      if (!this.elements.grid) return;

      clearElement(this.elements.grid);

      // Build dynamic groups based on available funds
      var dynamicGroups = this.buildDynamicGroups();

      dynamicGroups.forEach(function (group) {
        var groupEl = self.createFundGroup(group);
        self.elements.grid.appendChild(groupEl);
      });

      if (this.elements.value) {
        this.elements.value.textContent = this.state.selected;
      }

      var iconContainer = $(".fund-selector__icon", this.elements.container);
      if (iconContainer) {
        iconContainer.innerHTML = getFundIcon(this.state.selected);
      }
    },

    createFundGroup: function (group) {
      var self = this;

      var groupEl = createElement("div", "fund-selector__group");

      var icon = createElement("span", "fund-selector__group-icon");
      icon.innerHTML = FUND_ICONS[group.icon];
      groupEl.appendChild(icon);

      var separator = createElement("div", "fund-selector__group-separator");
      groupEl.appendChild(separator);

      var fundsContainer = createElement("div", "fund-selector__group-funds");

      group.funds.forEach(function (fund) {
        var isActive = fund === self.state.selected;
        var fundEl = createElement(
          "span",
          "fund-selector__fund" +
            (isActive ? " fund-selector__fund--active" : ""),
          fund
        );
        fundEl.addEventListener("click", function () {
          self.select(fund);
        });
        fundsContainer.appendChild(fundEl);
      });

      groupEl.appendChild(fundsContainer);
      return groupEl;
    },

    attachEvents: function () {
      var self = this;

      if (this.elements.trigger) {
        this.elements.trigger.addEventListener("click", function (e) {
          e.stopPropagation();
          self.toggle();
        });
      }

      document.addEventListener("click", function (e) {
        if (self.state.isOpen && !self.elements.container.contains(e.target)) {
          self.close();
        }
      });

      document.addEventListener("keydown", function (e) {
        if (!self.state.isOpen) return;
        if (e.key === "Escape") {
          self.close();
          if (self.elements.trigger) self.elements.trigger.focus();
        }
      });
    },

    toggle: function () {
      if (this.state.isOpen) {
        this.close();
      } else {
        this.open();
      }
    },

    open: function () {
      this.state.isOpen = true;
      this.elements.container.classList.add("fund-selector--open");
      this.elements.container.setAttribute("aria-expanded", "true");
    },

    close: function () {
      this.state.isOpen = false;
      this.elements.container.classList.remove("fund-selector--open");
      this.elements.container.setAttribute("aria-expanded", "false");
    },

    select: function (fund) {
      if (fund === this.state.selected) {
        this.close();
        return;
      }

      this.state.selected = fund;
      this.close();
      this.render();

      if (typeof this.state.onChange === "function") {
        this.state.onChange(fund);
      }
    },

    getSelected: function () {
      return this.state.selected;
    },

    setSelected: function (fund) {
      if (this.state.funds.indexOf(fund) !== -1) {
        this.state.selected = fund;
        this.render();
      }
    },
  };

  // ============================================================================
  // 7. COMPONENTS - ViewToggle.js
  // ============================================================================

  var VIEW_LABELS = {
    details: "Детали за текущий год",
    dynamics: "Динамика по годам",
  };

  var ViewToggle = {
    state: { mode: "details", onChange: null },
    elements: { button: null, text: null },

    init: function (options) {
      options = options || {};
      this.state.mode =
        options.mode || (window.DATA && window.DATA.viewMode) || "details";
      this.state.onChange = options.onChange || function () {};

      this.elements.button = $("#viewToggle");
      this.elements.text = $("#viewToggleText");
      this.elements.mobileButton = $("#viewToggleMobile");

      if (!this.elements.button && !this.elements.mobileButton) {
        console.error("ViewToggle: Button elements not found");
        return;
      }

      this.render();
      this.attachEvents();
    },

    render: function () {
      if (this.elements.text) {
        this.elements.text.textContent = VIEW_LABELS[this.state.mode];
      }

      // Update mobile button text
      if (this.elements.mobileButton) {
        var mobileText = this.elements.mobileButton.querySelector("span");
        if (mobileText) {
          mobileText.textContent = VIEW_LABELS[this.state.mode];
        }
      }

      if (this.elements.button) {
        var nextMode = this.state.mode === "details" ? "dynamics" : "details";
        this.elements.button.setAttribute(
          "aria-label",
          "Переключить на " + VIEW_LABELS[nextMode]
        );
      }
    },

    attachEvents: function () {
      var self = this;
      if (this.elements.button) {
        this.elements.button.addEventListener("click", function () {
          self.toggle();
        });
      }
      // Also bind mobile button
      if (this.elements.mobileButton) {
        this.elements.mobileButton.addEventListener("click", function () {
          self.toggle();
        });
      }
    },

    toggle: function () {
      this.state.mode = this.state.mode === "details" ? "dynamics" : "details";
      this.render();

      if (typeof this.state.onChange === "function") {
        this.state.onChange(this.state.mode);
      }
    },

    getMode: function () {
      return this.state.mode;
    },

    setMode: function (mode) {
      if (mode === "details" || mode === "dynamics") {
        this.state.mode = mode;
        this.render();
      }
    },
  };

  // ============================================================================
  // 8. MAIN - Dashboard.js
  // ============================================================================

  var Dashboard = {
    state: {
      currentFund: null,
      viewMode: "details",
      periods: [],
      periodData: [],
      chartConfig: {},
    },

    elements: {
      tableContainer: null,
      tableHeaders: null,
      tableSections: null,
      chartContainer: null,
      chartTitle: null,
    },

    init: function () {
      var rawData = window.DATA || DEFAULT_DATA;
      var config = processRawData(rawData);

      // Инициализируем FundsService с данными
      FundsService.init(config);

      // Используем FundsService для получения дефолтного фонда
      this.state.currentFund = FundsService.getDefaultFund();
      this.state.viewMode = config.viewMode || "details";
      this.state.periods = config.periods || DEFAULT_PERIODS;
      this.state.chartConfig = config.chartConfig || DEFAULT_CHART_CONFIG;

      this.elements.tableContainer = $(".content__table");
      this.elements.tableHeaders = $("#tableHeaderColumns");
      this.elements.tableSections = $("#tableSections");
      this.elements.chartContainer = $("#chartContainer");
      this.elements.chartTitle = $("#chartTitle");

      this.generateData();
      this.initComponents();
      this.updateThemeColors(this.state.currentFund);
      this.render();

      console.log("Dashboard initialized");
    },

    initComponents: function () {
      var self = this;

      // FundsService уже инициализирован, FundSelector получит данные из него
      FundSelector.init({
        selected: this.state.currentFund,
        onChange: function (fund) {
          self.handleFundChange(fund);
        },
      });

      ViewToggle.init({
        mode: this.state.viewMode,
        onChange: function (mode) {
          self.handleViewModeChange(mode);
        },
      });
    },

    generateData: function () {
      // Один путь данных через FundsService
      this.state.periodData = FundsService.getDashboardData(this.state.currentFund);
    },

    render: function () {
      // Toggle view mode class on table container
      if (this.elements.tableContainer) {
        this.elements.tableContainer.classList.toggle(
          "content__table--dynamics",
          this.state.viewMode === "dynamics"
        );
      }

      this.renderTableHeaders();
      this.renderTableSections();
      this.renderChart();
    },

    renderTableHeaders: function () {
      if (!this.elements.tableHeaders) return;

      clearElement(this.elements.tableHeaders);

      var headers = renderTableHeaders(
        this.state.periodData,
        this.state.viewMode
      );
      while (headers.firstChild) {
        this.elements.tableHeaders.appendChild(headers.firstChild);
      }
    },

    renderTableSections: function () {
      if (!this.elements.tableSections) return;

      clearElement(this.elements.tableSections);

      var sections = renderAllTableSections(
        this.state.periodData,
        this.state.viewMode,
        this.state.periods
      );

      this.elements.tableSections.appendChild(sections);
    },

    renderChart: function () {
      if (!this.elements.chartContainer) return;

      clearElement(this.elements.chartContainer);

      if (this.elements.chartTitle) {
        this.elements.chartTitle.textContent = this.state.chartConfig.title;
      }

      var metricKey = this.state.chartConfig.metric;

      var chartData = this.state.periods.map(function (period, index) {
        var periodInfo = this.state.periodData[index];
        var metricValue =
          periodInfo && periodInfo.metrics[metricKey]
            ? Math.abs(periodInfo.metrics[metricKey])
            : 0;
        return {
          label:
            period.label.indexOf("\n") !== -1
              ? "План '" + (period.shortLabel || "25")
              : period.label,
          value: metricValue,
          type: period.type,
        };
      }, this);

      // Calculate scale based on actual data
      var maxValue = Math.max.apply(
        null,
        chartData.map(function (d) {
          return d.value;
        })
      );
      this.state.chartConfig.scale = calculateChartScale(maxValue);

      var svg = renderBarChart(this.state.chartConfig, chartData);
      this.elements.chartContainer.appendChild(svg);
    },

    handleFundChange: function (fund) {
      this.state.currentFund = fund;
      this.updateThemeColors(fund);
      this.generateData();
      this.render();
    },

    /**
     * Обновить CSS переменные цветов на основе типа фонда
     * @param {string} fundName
     */
    updateThemeColors: function (fundName) {
      var colors = FundsService.getColors(fundName);
      var root = document.documentElement;
      root.style.setProperty("--color-primary-blue", colors.primary);
      root.style.setProperty("--color-section-header", colors.sectionHeader);
    },

    handleViewModeChange: function (mode) {
      this.state.viewMode = mode;
      this.render();
    },

    updateData: function (newData) {
      if (newData.periods) {
        this.state.periods = newData.periods;
      }
      if (newData.chartConfig) {
        this.state.chartConfig = Object.assign(
          {},
          this.state.chartConfig,
          newData.chartConfig
        );
      }
      if (newData.currentFund) {
        this.state.currentFund = newData.currentFund;
        FundSelector.setSelected(newData.currentFund);
      }

      this.generateData();
      this.render();
    },

    /**
     * Load data and re-render dashboard
     * @param {Object} rawData - Сырые данные (будут преобразованы через processRawData)
     */
    loadData: function (rawData) {
      // Преобразуем сырые данные в формат дашборда
      var data = processRawData(rawData);

      // Переинициализируем FundsService с новыми данными
      FundsService.init(data);

      // Обновляем текущий фонд если нужно
      var funds = FundsService.getFundsList();
      if (funds.length > 0 && funds.indexOf(this.state.currentFund) === -1) {
        this.state.currentFund = FundsService.getDefaultFund();
      }

      // Переинициализируем FundSelector с новыми данными
      FundSelector.init({
        selected: this.state.currentFund,
        onChange: this.handleFundChange.bind(this),
      });

      this.generateData();
      this.render();
    },

    getState: function () {
      return Object.assign({}, this.state);
    },
  };

  // ============================================================================
  // 9. CONTAIN-FIT SCALING
  // ============================================================================

  var ContainScale = {
    viewport: null,
    dashboard: null,
    designWidth: 1280,
    designHeight: 720,
    mobileDesignWidth: 320,
    mobileDesignHeight: 1360,

    init: function () {
      this.viewport = document.querySelector(".dashboard-viewport");
      this.dashboard = document.querySelector(".dashboard");

      if (!this.viewport || !this.dashboard) {
        console.warn("ContainScale: Required elements not found");
        return;
      }

      this.applyScale();
      this.attachEvents();
    },

    applyScale: function () {
      if (!this.viewport || !this.dashboard) return;

      // Get viewport dimensions
      var viewportWidth = window.innerWidth;
      var viewportHeight = window.innerHeight;

      // Choose design dimensions based on viewport width
      var isMobileViewport = viewportWidth < 768;
      var designWidth = isMobileViewport
        ? this.mobileDesignWidth
        : this.designWidth;
      var designHeight = isMobileViewport
        ? this.mobileDesignHeight
        : this.designHeight;

      // Calculate scale
      var scaleX = viewportWidth / designWidth;
      var scaleY = viewportHeight / designHeight;

      // Desktop: contain (fit entirely), Mobile: scale by width (allow scroll)
      var scale = isMobileViewport ? scaleX : Math.min(scaleX, scaleY);

      // Apply transform
      this.dashboard.style.transform = "scale(" + scale + ")";

      // Set viewport dimensions
      var scaledWidth = designWidth * scale;
      var scaledHeight = designHeight * scale;
      this.viewport.style.width = scaledWidth + "px";
      this.viewport.style.height = isMobileViewport ? "auto" : scaledHeight + "px";
    },

    attachEvents: function () {
      var self = this;
      var resizeTimeout;

      window.addEventListener("resize", function () {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function () {
          self.applyScale();
        }, 50);
      });
    },
  };

  // ============================================================================
  // 10. INITIALIZATION
  // ============================================================================

  function initDashboard() {
    Dashboard.init();
    ContainScale.init();

    // Re-render chart on resize (debounced)
    var resizeTimeout;
    var lastIsMobile = isMobile();

    window.addEventListener("resize", function () {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function () {
        var currentIsMobile = isMobile();
        // Only re-render if crossing the breakpoint
        if (currentIsMobile !== lastIsMobile) {
          lastIsMobile = currentIsMobile;
          Dashboard.renderChart();
        }
      }, 150);
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDashboard);
  } else {
    initDashboard();
  }

  // Expose to global scope for debugging
  window.BDDS = {
    Dashboard: Dashboard,
    FundSelector: FundSelector,
    ViewToggle: ViewToggle,
    ContainScale: ContainScale,
    formatNumber: formatNumber,
    FundsService: FundsService,
    processRawData: processRawData,
    // Data utilities (from generateData.js)
    METRIC_KEYS: METRIC_KEYS,
    calculateDelta: calculateDelta,
    parsePeriodInfo: parsePeriodInfo,
    DEFAULT_PERIODS: DEFAULT_PERIODS,
    DEFAULT_CHART_CONFIG: DEFAULT_CHART_CONFIG,
  };
})();
