<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BDDS Tests</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 10px; }
    .summary {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 18px;
    }
    .summary.pass { background: #d4edda; color: #155724; }
    .summary.fail { background: #f8d7da; color: #721c24; }
    .test-group {
      background: white;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test-group-header {
      padding: 12px 15px;
      background: #f8f9fa;
      font-weight: 600;
      border-bottom: 1px solid #e9ecef;
    }
    .test {
      padding: 10px 15px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .test:last-child { border-bottom: none; }
    .test.pass { background: #f0fff0; }
    .test.fail { background: #fff0f0; }
    .test-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }
    .test.pass .test-icon { background: #28a745; color: white; }
    .test.fail .test-icon { background: #dc3545; color: white; }
    .test-name { flex: 1; }
    .test-error {
      font-size: 12px;
      color: #dc3545;
      margin-top: 5px;
      font-family: monospace;
    }
    .test-details {
      font-size: 11px;
      color: #666;
      font-family: monospace;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>BDDS Tests</h1>
  <div id="summary" class="summary"></div>
  <div id="results"></div>

  <!-- Load dependencies -->
  <script src="script.js"></script>

  <script>
    // Aliases for BDDS namespace (for cleaner test code)
    const { METRIC_KEYS, calculateDelta, parsePeriodInfo, DEFAULT_PERIODS, DEFAULT_CHART_CONFIG } = BDDS;

    // Simple test framework
    const tests = [];
    let currentGroup = null;

    function describe(name, fn) {
      currentGroup = { name, tests: [] };
      tests.push(currentGroup);
      fn();
      currentGroup = null;
    }

    function it(name, fn) {
      const test = { name, fn, passed: false, error: null };
      if (currentGroup) {
        currentGroup.tests.push(test);
      }
    }

    function expect(actual) {
      return {
        toBe(expected) {
          if (actual !== expected) {
            throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
          }
        },
        toEqual(expected) {
          if (JSON.stringify(actual) !== JSON.stringify(expected)) {
            throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
          }
        },
        toBeNull() {
          if (actual !== null) {
            throw new Error(`Expected null, got ${JSON.stringify(actual)}`);
          }
        },
        toBeArray() {
          if (!Array.isArray(actual)) {
            throw new Error(`Expected array, got ${typeof actual}`);
          }
        },
        toBeObject() {
          if (typeof actual !== 'object' || actual === null || Array.isArray(actual)) {
            throw new Error(`Expected object, got ${typeof actual}`);
          }
        },
        toContain(item) {
          if (!actual.includes(item)) {
            throw new Error(`Expected ${JSON.stringify(actual)} to contain ${JSON.stringify(item)}`);
          }
        },
        toHaveLength(len) {
          if (actual.length !== len) {
            throw new Error(`Expected length ${len}, got ${actual.length}`);
          }
        },
        toHaveProperty(prop) {
          if (!(prop in actual)) {
            throw new Error(`Expected object to have property "${prop}"`);
          }
        },
        toBeTruthy() {
          if (!actual) {
            throw new Error(`Expected truthy value, got ${JSON.stringify(actual)}`);
          }
        },
        toBeGreaterThan(n) {
          if (actual <= n) {
            throw new Error(`Expected ${actual} to be greater than ${n}`);
          }
        }
      };
    }

    // Test data
    const TEST_DATA = {
      funds: {
        "TestFund1": {
          type: "building",
          periods: {
            "Факт '23": {
              "Движение Д/С по операционной деятельности ООО": 100000,
              "Поступления по операционной деятельности": 200000
            },
            "План '26": {
              "Движение Д/С по операционной деятельности ООО": 150000,
              "Поступления по операционной деятельности": 250000
            }
          }
        },
        "TestFund2": {
          type: "warehouse",
          periods: {
            "Факт '24": {
              "Движение Д/С по операционной деятельности ООО": 300000
            }
          }
        },
        "TestFund3": {
          type: "briefcase",
          periods: {}
        }
      },
      currentFund: "TestFund1",
      viewMode: "details"
    };

    // =====================
    // FundsService Tests
    // =====================

    describe('FundsService.init()', function() {
      it('должен инициализировать сервис с данными', function() {
        const result = BDDS.FundsService.init(TEST_DATA);
        expect(result).toBe(BDDS.FundsService); // returns self for chaining
      });

      it('должен работать с пустыми данными', function() {
        BDDS.FundsService.init({});
        expect(BDDS.FundsService.getFundsList()).toEqual([]);
        BDDS.FundsService.init(TEST_DATA); // restore
      });

      it('должен работать с null', function() {
        BDDS.FundsService.init(null);
        expect(BDDS.FundsService.getFundsList()).toEqual([]);
        BDDS.FundsService.init(TEST_DATA); // restore
      });
    });

    describe('FundsService.getFundsList()', function() {
      it('должен возвращать массив названий фондов', function() {
        BDDS.FundsService.init(TEST_DATA);
        const funds = BDDS.FundsService.getFundsList();
        expect(funds).toBeArray();
        expect(funds).toHaveLength(3);
      });

      it('должен содержать все фонды из данных', function() {
        const funds = BDDS.FundsService.getFundsList();
        expect(funds).toContain("TestFund1");
        expect(funds).toContain("TestFund2");
        expect(funds).toContain("TestFund3");
      });

      it('должен возвращать пустой массив если нет данных', function() {
        BDDS.FundsService.init({});
        expect(BDDS.FundsService.getFundsList()).toEqual([]);
        BDDS.FundsService.init(TEST_DATA);
      });
    });

    describe('FundsService.getDefaultFund()', function() {
      it('должен возвращать currentFund если указан', function() {
        BDDS.FundsService.init(TEST_DATA);
        expect(BDDS.FundsService.getDefaultFund()).toBe("TestFund1");
      });

      it('должен возвращать первый фонд если currentFund не указан', function() {
        const dataWithoutCurrent = { funds: TEST_DATA.funds };
        BDDS.FundsService.init(dataWithoutCurrent);
        expect(BDDS.FundsService.getDefaultFund()).toBe("TestFund1");
        BDDS.FundsService.init(TEST_DATA);
      });

      it('должен возвращать null если нет фондов', function() {
        BDDS.FundsService.init({});
        expect(BDDS.FundsService.getDefaultFund()).toBeNull();
        BDDS.FundsService.init(TEST_DATA);
      });
    });

    describe('FundsService.getFundType()', function() {
      it('должен возвращать тип иконки фонда', function() {
        BDDS.FundsService.init(TEST_DATA);
        expect(BDDS.FundsService.getFundType("TestFund1")).toBe("building");
        expect(BDDS.FundsService.getFundType("TestFund2")).toBe("warehouse");
        expect(BDDS.FundsService.getFundType("TestFund3")).toBe("briefcase");
      });

      it('должен возвращать "building" для несуществующего фонда', function() {
        expect(BDDS.FundsService.getFundType("NonExistent")).toBe("building");
      });
    });

    describe('FundsService.getIcon()', function() {
      it('должен возвращать SVG-строку', function() {
        BDDS.FundsService.init(TEST_DATA);
        const icon = BDDS.FundsService.getIcon("TestFund1");
        expect(icon).toContain("<svg");
        expect(icon).toContain("viewBox");
      });

      it('должен возвращать разные иконки для разных типов', function() {
        const icon1 = BDDS.FundsService.getIcon("TestFund1"); // building
        const icon2 = BDDS.FundsService.getIcon("TestFund2"); // warehouse
        // They should be different SVGs
        expect(icon1 !== icon2).toBeTruthy();
      });
    });

    describe('FundsService.getGroups()', function() {
      it('должен возвращать массив групп', function() {
        BDDS.FundsService.init(TEST_DATA);
        const groups = BDDS.FundsService.getGroups();
        expect(groups).toBeArray();
      });

      it('каждая группа должна иметь icon и funds', function() {
        const groups = BDDS.FundsService.getGroups();
        groups.forEach(function(group) {
          expect(group).toHaveProperty("icon");
          expect(group).toHaveProperty("funds");
          expect(group.funds).toBeArray();
        });
      });

      it('должен группировать фонды по типам', function() {
        const groups = BDDS.FundsService.getGroups();
        const buildingGroup = groups.find(g => g.icon === "building");
        const warehouseGroup = groups.find(g => g.icon === "warehouse");

        expect(buildingGroup.funds).toContain("TestFund1");
        expect(warehouseGroup.funds).toContain("TestFund2");
      });
    });

    describe('FundsService.getPeriods()', function() {
      it('должен возвращать объект периодов', function() {
        BDDS.FundsService.init(TEST_DATA);
        const periods = BDDS.FundsService.getPeriods("TestFund1");
        expect(periods).toBeObject();
      });

      it('должен содержать данные метрик', function() {
        const periods = BDDS.FundsService.getPeriods("TestFund1");
        expect(periods).toHaveProperty("Факт '23");
        expect(periods["Факт '23"]["Движение Д/С по операционной деятельности ООО"]).toBe(100000);
      });

      it('должен возвращать пустой объект для несуществующего фонда', function() {
        const periods = BDDS.FundsService.getPeriods("NonExistent");
        expect(periods).toEqual({});
      });
    });

    describe('FundsService.getPeriodsList()', function() {
      it('должен возвращать массив названий периодов', function() {
        BDDS.FundsService.init(TEST_DATA);
        const periods = BDDS.FundsService.getPeriodsList("TestFund1");
        expect(periods).toBeArray();
        expect(periods).toHaveLength(2);
      });

      it('должен содержать правильные названия', function() {
        const periods = BDDS.FundsService.getPeriodsList("TestFund1");
        expect(periods).toContain("Факт '23");
        expect(periods).toContain("План '26");
      });

      it('должен возвращать пустой массив для фонда без периодов', function() {
        const periods = BDDS.FundsService.getPeriodsList("TestFund3");
        expect(periods).toEqual([]);
      });
    });

    describe('FundsService.getAllFundsWithPeriods()', function() {
      it('должен возвращать объект со всеми фондами', function() {
        BDDS.FundsService.init(TEST_DATA);
        const all = BDDS.FundsService.getAllFundsWithPeriods();
        expect(all).toBeObject();
        expect(all).toHaveProperty("TestFund1");
        expect(all).toHaveProperty("TestFund2");
        expect(all).toHaveProperty("TestFund3");
      });

      it('значения должны быть массивами периодов', function() {
        const all = BDDS.FundsService.getAllFundsWithPeriods();
        expect(all["TestFund1"]).toBeArray();
        expect(all["TestFund1"]).toContain("Факт '23");
      });
    });

    describe('FundsService.getDashboardData()', function() {
      it('должен возвращать массив периодов', function() {
        BDDS.FundsService.init(TEST_DATA);
        const data = BDDS.FundsService.getDashboardData("TestFund1");
        expect(data).toBeArray();
        expect(data).toHaveLength(2);
      });

      it('каждый элемент должен иметь нужные поля', function() {
        const data = BDDS.FundsService.getDashboardData("TestFund1");
        data.forEach(function(period) {
          expect(period).toHaveProperty("id");
          expect(period).toHaveProperty("title");
          expect(period).toHaveProperty("type");
          expect(period).toHaveProperty("year");
          expect(period).toHaveProperty("metrics");
        });
      });

      it('должен сортировать по году', function() {
        const data = BDDS.FundsService.getDashboardData("TestFund1");
        expect(data[0].year).toBe(2023);
        expect(data[1].year).toBe(2026);
      });

      it('должен правильно определять тип периода', function() {
        const data = BDDS.FundsService.getDashboardData("TestFund1");
        const fact = data.find(p => p.title === "Факт '23");
        const plan = data.find(p => p.title === "План '26");
        expect(fact.type).toBe("fact");
        expect(plan.type).toBe("plan");
      });
    });

    // =====================
    // getFundsData() Tests
    // =====================

    describe('getFundsData()', function() {
      it('должен возвращать объект с фондами', function() {
        const result = BDDS.getFundsData(TEST_DATA);
        expect(result).toBeObject();
        expect(result).toHaveProperty("TestFund1");
      });

      it('должен содержать периоды фондов', function() {
        const result = BDDS.getFundsData(TEST_DATA);
        expect(result["TestFund1"]).toHaveProperty("Факт '23");
      });

      it('должен возвращать пустой объект для пустых данных', function() {
        expect(BDDS.getFundsData({})).toEqual({});
        expect(BDDS.getFundsData(null)).toEqual({});
      });
    });

    // =====================
    // Dashboard.loadData() Tests
    // =====================

    describe('Dashboard.loadData()', function() {
      it('должен загружать новые данные', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        expect(BDDS.Dashboard.state.currentFund).toBe("TestFund1");
      });

      it('должен обновлять periodData', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        expect(BDDS.Dashboard.state.periodData).toBeArray();
        expect(BDDS.Dashboard.state.periodData.length).toBeGreaterThan(0);
      });

      it('должен работать с минимальными данными', function() {
        BDDS.Dashboard.loadData({
          funds: {
            "MinimalFund": {
              type: "building",
              periods: {
                "Факт '24": { "Движение Д/С по операционной деятельности ООО": 1 }
              }
            }
          }
        });
        expect(BDDS.Dashboard.state.currentFund).toBe("MinimalFund");
        expect(BDDS.FundsService.getFundsList()).toContain("MinimalFund");
      });

      it('должен переключаться на дефолтный фонд если текущий не найден', function() {
        // First load with TestFund1
        BDDS.Dashboard.loadData(TEST_DATA);
        expect(BDDS.Dashboard.state.currentFund).toBe("TestFund1");

        // Then load without TestFund1
        BDDS.Dashboard.loadData({
          funds: {
            "NewFund": { type: "warehouse", periods: { "Факт '24": {} } }
          }
        });
        expect(BDDS.Dashboard.state.currentFund).toBe("NewFund");
      });
    });

    // =====================
    // parsePeriodInfo() Tests
    // =====================

    describe('parsePeriodInfo()', function() {
      it('должен парсить факт', function() {
        const info = parsePeriodInfo("Факт '23");
        expect(info.type).toBe("fact");
        expect(info.year).toBe(2023);
      });

      it('должен парсить план', function() {
        const info = parsePeriodInfo("План '26");
        expect(info.type).toBe("plan");
        expect(info.year).toBe(2026);
      });

      it('должен парсить смешанный период', function() {
        const info = parsePeriodInfo("Факт (I-III кв. '25)\nПлан (IV кв. '25)");
        expect(info.type).toBe("mixed");
        expect(info.year).toBe(2025);
      });
    });

    // =====================
    // formatNumber() Tests
    // =====================

    describe('formatNumber()', function() {
      it('должен форматировать числа с пробелами', function() {
        expect(BDDS.formatNumber(1000)).toBe("1 000");
        expect(BDDS.formatNumber(1000000)).toBe("1 000 000");
      });

      it('должен обрабатывать отрицательные числа (в скобках)', function() {
        expect(BDDS.formatNumber(-1000)).toBe("(1 000)");
        expect(BDDS.formatNumber(-1234567)).toBe("(1 234 567)");
      });

      it('должен возвращать "-" для null/undefined', function() {
        expect(BDDS.formatNumber(null)).toBe("-");
        expect(BDDS.formatNumber(undefined)).toBe("-");
      });

      it('должен обрабатывать ноль', function() {
        expect(BDDS.formatNumber(0)).toBe("0");
      });

      it('должен округлять дробные числа', function() {
        const result = BDDS.formatNumber(1234.56);
        expect(result).toBe("1 235");
      });
    });

    // =====================
    // calculateDelta() Tests
    // =====================

    describe('calculateDelta()', function() {
      it('должен вычислять процент изменения', function() {
        expect(calculateDelta(110, 100)).toBe(10);
        expect(calculateDelta(200, 100)).toBe(100);
        expect(calculateDelta(50, 100)).toBe(-50);
      });

      it('должен возвращать null если значения null', function() {
        expect(calculateDelta(null, 100)).toBeNull();
        expect(calculateDelta(100, null)).toBeNull();
        expect(calculateDelta(null, null)).toBeNull();
      });

      it('должен обрабатывать деление на ноль', function() {
        expect(calculateDelta(100, 0)).toBe(100);
        expect(calculateDelta(0, 0)).toBe(0);
      });

      it('должен округлять результат', function() {
        expect(calculateDelta(133, 100)).toBe(33);
        expect(calculateDelta(167, 100)).toBe(67);
      });
    });

    // =====================
    // Dashboard Methods Tests
    // =====================

    describe('Dashboard.init()', function() {
      it('Dashboard должен быть инициализирован', function() {
        expect(BDDS.Dashboard).toBeObject();
        expect(BDDS.Dashboard.state).toBeObject();
      });

      it('должен иметь currentFund в state', function() {
        expect(BDDS.Dashboard.state).toHaveProperty("currentFund");
      });

      it('должен иметь periodData в state', function() {
        expect(BDDS.Dashboard.state).toHaveProperty("periodData");
        expect(BDDS.Dashboard.state.periodData).toBeArray();
      });

      it('должен иметь viewMode в state', function() {
        expect(BDDS.Dashboard.state).toHaveProperty("viewMode");
      });
    });

    describe('Dashboard.generateData()', function() {
      it('должен генерировать periodData', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        BDDS.Dashboard.generateData();
        expect(BDDS.Dashboard.state.periodData).toBeArray();
        expect(BDDS.Dashboard.state.periodData.length).toBeGreaterThan(0);
      });

      it('periodData должен содержать объекты с metrics', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        BDDS.Dashboard.generateData();
        const firstPeriod = BDDS.Dashboard.state.periodData[0];
        expect(firstPeriod).toHaveProperty("metrics");
        expect(firstPeriod.metrics).toBeObject();
      });
    });

    describe('Dashboard.handleFundChange()', function() {
      it('должен менять текущий фонд', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        BDDS.Dashboard.handleFundChange("TestFund2");
        expect(BDDS.Dashboard.state.currentFund).toBe("TestFund2");
      });

      it('должен обновлять periodData при смене фонда', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        BDDS.Dashboard.handleFundChange("TestFund2");
        const data = BDDS.Dashboard.state.periodData;
        expect(data[0].metrics["Движение Д/С по операционной деятельности ООО"]).toBe(300000);
      });
    });

    describe('Dashboard.handleViewModeChange()', function() {
      it('должен менять viewMode', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        BDDS.Dashboard.handleViewModeChange("dynamics");
        expect(BDDS.Dashboard.state.viewMode).toBe("dynamics");

        BDDS.Dashboard.handleViewModeChange("details");
        expect(BDDS.Dashboard.state.viewMode).toBe("details");
      });
    });

    describe('Dashboard.updateData()', function() {
      it('должен обновлять currentFund', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        BDDS.Dashboard.updateData({ currentFund: "TestFund2" });
        expect(BDDS.Dashboard.state.currentFund).toBe("TestFund2");
      });

      it('должен обновлять chartConfig', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        BDDS.Dashboard.updateData({ chartConfig: { customValues: [100, 200, 300, 400] } });
        expect(BDDS.Dashboard.state.chartConfig.customValues).toBeArray();
        expect(BDDS.Dashboard.state.chartConfig.customValues[0]).toBe(100);
      });
    });

    describe('Dashboard.getState()', function() {
      it('должен возвращать копию state', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        const state = BDDS.Dashboard.getState();
        expect(state).toBeObject();
        expect(state).toHaveProperty("currentFund");
        expect(state).toHaveProperty("periodData");
        expect(state).toHaveProperty("viewMode");
      });
    });

    // =====================
    // FundSelector Tests
    // =====================

    describe('FundSelector', function() {
      it('должен быть доступен через BDDS', function() {
        expect(BDDS.FundSelector).toBeObject();
      });

      it('должен иметь state', function() {
        expect(BDDS.FundSelector.state).toBeObject();
      });

      it('должен иметь метод getSelected', function() {
        expect(typeof BDDS.FundSelector.getSelected).toBe("function");
      });

      it('getSelected должен возвращать текущий фонд', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        const selected = BDDS.FundSelector.getSelected();
        expect(selected).toBe(BDDS.Dashboard.state.currentFund);
      });

      it('должен иметь метод setSelected', function() {
        expect(typeof BDDS.FundSelector.setSelected).toBe("function");
      });

      it('должен иметь метод buildDynamicGroups', function() {
        expect(typeof BDDS.FundSelector.buildDynamicGroups).toBe("function");
      });

      it('buildDynamicGroups должен возвращать группы', function() {
        BDDS.Dashboard.loadData(TEST_DATA);
        const groups = BDDS.FundSelector.buildDynamicGroups();
        expect(groups).toBeArray();
      });
    });

    // =====================
    // ViewToggle Tests
    // =====================

    describe('ViewToggle', function() {
      it('должен быть доступен через BDDS', function() {
        expect(BDDS.ViewToggle).toBeObject();
      });

      it('должен иметь state', function() {
        expect(BDDS.ViewToggle.state).toBeObject();
      });

      it('должен иметь метод getMode', function() {
        expect(typeof BDDS.ViewToggle.getMode).toBe("function");
      });

      it('getMode должен возвращать текущий режим', function() {
        const mode = BDDS.ViewToggle.getMode();
        expect(mode === "details" || mode === "dynamics").toBeTruthy();
      });

      it('должен иметь метод setMode', function() {
        expect(typeof BDDS.ViewToggle.setMode).toBe("function");
      });

      it('должен иметь метод toggle', function() {
        expect(typeof BDDS.ViewToggle.toggle).toBe("function");
      });
    });

    // =====================
    // ContainScale Tests
    // =====================

    describe('ContainScale', function() {
      it('должен быть доступен через BDDS', function() {
        expect(BDDS.ContainScale).toBeObject();
      });

      it('должен иметь метод init', function() {
        expect(typeof BDDS.ContainScale.init).toBe("function");
      });

      it('должен иметь метод applyScale', function() {
        expect(typeof BDDS.ContainScale.applyScale).toBe("function");
      });
    });

    // =====================
    // METRIC_KEYS Tests
    // =====================

    describe('METRIC_KEYS', function() {
      it('должен быть объектом', function() {
        expect(METRIC_KEYS).toBeObject();
      });

      it('должен содержать ключи для операционной деятельности', function() {
        expect(METRIC_KEYS).toHaveProperty("OPERATION_MOVEMENT");
        expect(METRIC_KEYS).toHaveProperty("OPERATION_INCOME");
        expect(METRIC_KEYS).toHaveProperty("OPERATION_EXPENSE");
      });

      it('должен содержать ключи для инвестиционной деятельности', function() {
        expect(METRIC_KEYS).toHaveProperty("INVESTMENT_MOVEMENT");
        expect(METRIC_KEYS).toHaveProperty("INVESTMENT_DIVIDENDS");
      });

      it('должен содержать ключи для финансовой деятельности', function() {
        expect(METRIC_KEYS).toHaveProperty("FINANCE_MOVEMENT");
        expect(METRIC_KEYS).toHaveProperty("FINANCE_CREDITS");
      });

      it('должен содержать ключи для остатков', function() {
        expect(METRIC_KEYS).toHaveProperty("CASH_START");
        expect(METRIC_KEYS).toHaveProperty("CASH_END");
        expect(METRIC_KEYS).toHaveProperty("CREDIT_START");
        expect(METRIC_KEYS).toHaveProperty("CREDIT_END");
      });
    });

    // =====================
    // DEFAULT_CHART_CONFIG Tests
    // =====================

    describe('DEFAULT_CHART_CONFIG', function() {
      it('должен быть объектом', function() {
        expect(DEFAULT_CHART_CONFIG).toBeObject();
      });

      it('должен содержать title', function() {
        expect(DEFAULT_CHART_CONFIG).toHaveProperty("title");
      });

      it('должен содержать scale с min, max, step', function() {
        expect(DEFAULT_CHART_CONFIG).toHaveProperty("scale");
        expect(DEFAULT_CHART_CONFIG.scale).toHaveProperty("min");
        expect(DEFAULT_CHART_CONFIG.scale).toHaveProperty("max");
        expect(DEFAULT_CHART_CONFIG.scale).toHaveProperty("step");
      });

      it('должен содержать colors', function() {
        expect(DEFAULT_CHART_CONFIG).toHaveProperty("colors");
        expect(DEFAULT_CHART_CONFIG.colors).toHaveProperty("fact");
        expect(DEFAULT_CHART_CONFIG.colors).toHaveProperty("plan");
      });
    });

    // =====================
    // Integration Tests
    // =====================

    describe('Integration: Полный цикл загрузки данных', function() {
      it('должен загружать данные и обновлять все компоненты', function() {
        const testData = {
          funds: {
            "IntegrationFund1": {
              type: "building",
              periods: {
                "Факт '23": { "Движение Д/С по операционной деятельности ООО": 500000 },
                "План '26": { "Движение Д/С по операционной деятельности ООО": 600000 }
              }
            },
            "IntegrationFund2": {
              type: "warehouse",
              periods: {
                "Факт '24": { "Движение Д/С по операционной деятельности ООО": 700000 }
              }
            }
          },
          currentFund: "IntegrationFund1"
        };

        BDDS.Dashboard.loadData(testData);

        // Check FundsService
        expect(BDDS.FundsService.getFundsList()).toContain("IntegrationFund1");
        expect(BDDS.FundsService.getFundsList()).toContain("IntegrationFund2");

        // Check Dashboard state
        expect(BDDS.Dashboard.state.currentFund).toBe("IntegrationFund1");
        expect(BDDS.Dashboard.state.periodData).toBeArray();

        // Check FundSelector
        expect(BDDS.FundSelector.getSelected()).toBe("IntegrationFund1");

        // Check data integrity
        const periods = BDDS.FundsService.getDashboardData("IntegrationFund1");
        expect(periods).toHaveLength(2);
        expect(periods[0].metrics["Движение Д/С по операционной деятельности ООО"]).toBe(500000);
      });

      it('должен корректно переключать фонды', function() {
        BDDS.Dashboard.loadData(TEST_DATA);

        // Switch to TestFund2
        BDDS.Dashboard.handleFundChange("TestFund2");

        expect(BDDS.Dashboard.state.currentFund).toBe("TestFund2");
        expect(BDDS.Dashboard.state.periodData[0].metrics["Движение Д/С по операционной деятельности ООО"]).toBe(300000);

        // Switch back
        BDDS.Dashboard.handleFundChange("TestFund1");
        expect(BDDS.Dashboard.state.currentFund).toBe("TestFund1");
      });
    });

    // =====================
    // Run Tests
    // =====================

    function runTests() {
      let passed = 0;
      let failed = 0;
      const resultsEl = document.getElementById('results');
      const summaryEl = document.getElementById('summary');

      tests.forEach(function(group) {
        const groupEl = document.createElement('div');
        groupEl.className = 'test-group';

        const headerEl = document.createElement('div');
        headerEl.className = 'test-group-header';
        headerEl.textContent = group.name;
        groupEl.appendChild(headerEl);

        group.tests.forEach(function(test) {
          try {
            test.fn();
            test.passed = true;
            passed++;
          } catch (e) {
            test.passed = false;
            test.error = e.message;
            failed++;
          }

          const testEl = document.createElement('div');
          testEl.className = 'test ' + (test.passed ? 'pass' : 'fail');

          testEl.innerHTML = `
            <div class="test-icon">${test.passed ? '✓' : '✗'}</div>
            <div class="test-name">
              ${test.name}
              ${test.error ? '<div class="test-error">' + test.error + '</div>' : ''}
            </div>
          `;

          groupEl.appendChild(testEl);
        });

        resultsEl.appendChild(groupEl);
      });

      const total = passed + failed;
      summaryEl.className = 'summary ' + (failed === 0 ? 'pass' : 'fail');
      summaryEl.innerHTML = `
        <strong>${failed === 0 ? '✓ Все тесты пройдены!' : '✗ Есть ошибки'}</strong><br>
        Пройдено: ${passed}/${total} | Ошибок: ${failed}
      `;
    }

    // Wait for BDDS to be available
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(runTests, 100);
      });
    } else {
      setTimeout(runTests, 100);
    }
  </script>
</body>
</html>
