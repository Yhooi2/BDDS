<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BDDS Dashboard Tests</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }

    .summary {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .summary-stats {
      display: flex;
      gap: 20px;
      font-size: 18px;
    }

    .summary-stats .pass {
      color: #22c55e;
    }

    .summary-stats .fail {
      color: #ef4444;
    }

    .suite {
      background: #fff;
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .suite-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      color: #1e40af;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
    }

    .test {
      padding: 5px 0;
      padding-left: 20px;
      border-left: 3px solid transparent;
      margin: 3px 0;
    }

    .test.pass {
      color: #22c55e;
      border-left-color: #22c55e;
      background: #f0fdf4;
    }

    .test.fail {
      color: #ef4444;
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .test-error {
      font-size: 12px;
      color: #991b1b;
      margin-left: 20px;
      font-style: italic;
    }

    .icon {
      margin-right: 8px;
    }

    .reload-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .reload-btn:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <h1>BDDS Dashboard Tests</h1>

  <div class="summary">
    <div class="summary-stats">
      <span class="pass">Passed: <span id="passed-count">0</span></span>
      <span class="fail">Failed: <span id="failed-count">0</span></span>
      <span>Total: <span id="total-count">0</span></span>
    </div>
    <button class="reload-btn" onclick="location.reload()">Re-run Tests</button>
  </div>

  <div id="results"></div>

  <!-- Load modules -->
  <script src="formatNumber.js"></script>
  <script src="generateData.js"></script>
  <script src="dom.js"></script>

  <script>
    // ========================================
    // TEST RUNNER
    // ========================================
    const testResults = [];
    let currentSuite = null;

    function describe(suiteName, fn) {
      currentSuite = { name: suiteName, tests: [] };
      testResults.push(currentSuite);
      fn();
      currentSuite = null;
    }

    function it(testName, fn) {
      if (!currentSuite) {
        console.error('it() must be called inside describe()');
        return;
      }

      try {
        fn();
        currentSuite.tests.push({ name: testName, pass: true, error: null });
      } catch (e) {
        currentSuite.tests.push({ name: testName, pass: false, error: e.message });
      }
    }

    function assertEqual(actual, expected, message = '') {
      if (actual !== expected) {
        throw new Error(message || `Expected "${expected}", got "${actual}"`);
      }
    }

    function assertDeepEqual(actual, expected, message = '') {
      if (JSON.stringify(actual) !== JSON.stringify(expected)) {
        throw new Error(message || `Objects not equal: ${JSON.stringify(actual)} vs ${JSON.stringify(expected)}`);
      }
    }

    function assertTrue(value, message = '') {
      if (value !== true) {
        throw new Error(message || `Expected true, got ${value}`);
      }
    }

    function assertFalse(value, message = '') {
      if (value !== false) {
        throw new Error(message || `Expected false, got ${value}`);
      }
    }

    function assertDefined(value, message = '') {
      if (value === undefined || value === null) {
        throw new Error(message || `Expected defined value, got ${value}`);
      }
    }

    function assertApproxEqual(actual, expected, tolerance = 1, message = '') {
      if (Math.abs(actual - expected) > tolerance) {
        throw new Error(message || `Expected ~${expected}, got ${actual} (tolerance: ${tolerance})`);
      }
    }

    function renderResults() {
      const container = document.getElementById('results');
      let totalPassed = 0;
      let totalFailed = 0;

      testResults.forEach(suite => {
        const div = document.createElement('div');
        div.className = 'suite';

        const title = document.createElement('div');
        title.className = 'suite-title';
        title.textContent = suite.name;
        div.appendChild(title);

        suite.tests.forEach(test => {
          const testDiv = document.createElement('div');
          testDiv.className = `test ${test.pass ? 'pass' : 'fail'}`;

          const icon = test.pass ? '✓' : '✗';
          testDiv.innerHTML = `<span class="icon">${icon}</span>${test.name}`;

          if (test.error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'test-error';
            errorDiv.textContent = test.error;
            testDiv.appendChild(errorDiv);
          }

          div.appendChild(testDiv);

          if (test.pass) totalPassed++;
          else totalFailed++;
        });

        container.appendChild(div);
      });

      // Update summary
      document.getElementById('passed-count').textContent = totalPassed;
      document.getElementById('failed-count').textContent = totalFailed;
      document.getElementById('total-count').textContent = totalPassed + totalFailed;
    }
  </script>

  <!-- ========================================
       TESTS
       ======================================== -->
  <script>
    // ========================================
    // formatNumber.js tests
    // ========================================
    describe('formatNumber', () => {
      it('formats positive number with spaces', () => {
        assertEqual(formatNumber(1366339), '1 366 339');
      });

      it('formats negative number', () => {
        assertEqual(formatNumber(-850000), '-850 000');
      });

      it('formats zero', () => {
        assertEqual(formatNumber(0), '0');
      });

      it('formats small number without spaces', () => {
        assertEqual(formatNumber(123), '123');
      });

      it('formats thousands', () => {
        assertEqual(formatNumber(1000), '1 000');
      });

      it('handles null/undefined', () => {
        assertEqual(formatNumber(null), '0');
        assertEqual(formatNumber(undefined), '0');
      });

      it('handles NaN', () => {
        assertEqual(formatNumber(NaN), '0');
      });
    });

    describe('formatWithDelta', () => {
      it('formats value with delta percentage', () => {
        assertEqual(formatWithDelta(1366339, 10), '1 366 339 (10%)');
      });

      it('formats with negative delta', () => {
        assertEqual(formatWithDelta(1000000, -5), '1 000 000 (-5%)');
      });

      it('formats with zero delta', () => {
        assertEqual(formatWithDelta(500000, 0), '500 000 (0%)');
      });

      it('rounds delta to integer', () => {
        assertEqual(formatWithDelta(1000000, 10.7), '1 000 000 (11%)');
      });
    });

    describe('formatShort', () => {
      it('formats number without spaces', () => {
        assertEqual(formatShort(390), '390');
      });

      it('handles large numbers', () => {
        assertEqual(formatShort(1000), '1000');
      });

      it('rounds decimals', () => {
        assertEqual(formatShort(390.6), '391');
      });
    });

    describe('isNegative', () => {
      it('returns true for negative numbers', () => {
        assertTrue(isNegative(-100));
      });

      it('returns false for positive numbers', () => {
        assertFalse(isNegative(100));
      });

      it('returns false for zero', () => {
        assertFalse(isNegative(0));
      });

      it('returns false for non-numbers', () => {
        assertFalse(isNegative('test'));
        assertFalse(isNegative(null));
      });
    });

    // ========================================
    // generateData.js tests
    // ========================================
    describe('generatePeriodData', () => {
      it('generates correct number of periods', () => {
        const periods = [
          { year: 2023, type: 'fact', label: "Факт '23" },
          { year: 2024, type: 'fact', label: "Факт '24" }
        ];
        const result = generatePeriodData(periods, 1);
        assertEqual(result.length, 2);
      });

      it('preserves period labels', () => {
        const periods = [{ year: 2023, type: 'fact', label: "Факт '23" }];
        const result = generatePeriodData(periods, 1);
        assertEqual(result[0].title, "Факт '23");
      });

      it('preserves period type', () => {
        const periods = [{ year: 2023, type: 'plan', label: "План '23" }];
        const result = generatePeriodData(periods, 1);
        assertEqual(result[0].type, 'plan');
      });

      it('returns empty array for empty input', () => {
        const result = generatePeriodData([], 1);
        assertEqual(result.length, 0);
      });

      it('returns empty array for null input', () => {
        const result = generatePeriodData(null, 1);
        assertEqual(result.length, 0);
      });

      it('applies fund multiplier to values', () => {
        const periods = [{ year: 2023, type: 'fact', label: "Test" }];
        const result1 = generatePeriodData(periods, 1);
        const result2 = generatePeriodData(periods, 2);

        // Values should be doubled with multiplier 2
        const key = METRIC_KEYS.OPERATION_INCOME;
        assertEqual(result2[0].metrics[key], result1[0].metrics[key] * 2);
      });

      it('applies year multiplier across periods', () => {
        const periods = [
          { year: 2023, type: 'fact', label: "Y1" },
          { year: 2024, type: 'fact', label: "Y2" },
          { year: 2025, type: 'fact', label: "Y3" }
        ];
        const result = generatePeriodData(periods, 1);

        const key = METRIC_KEYS.OPERATION_INCOME;
        // Each period should have higher values than previous
        assertTrue(result[1].metrics[key] > result[0].metrics[key]);
        assertTrue(result[2].metrics[key] > result[1].metrics[key]);
      });

      it('generates all required metrics', () => {
        const periods = [{ year: 2023, type: 'fact', label: "Test" }];
        const result = generatePeriodData(periods, 1);
        const metrics = result[0].metrics;

        // Check some key metrics exist
        assertDefined(metrics[METRIC_KEYS.OPERATION_INCOME]);
        assertDefined(metrics[METRIC_KEYS.INVESTMENT_DIVIDENDS]);
        assertDefined(metrics[METRIC_KEYS.FINANCE_CREDITS]);
        assertDefined(metrics[METRIC_KEYS.CREDIT_START]);
        assertDefined(metrics[METRIC_KEYS.CASH_END]);
      });
    });

    describe('getMetricValue', () => {
      it('returns correct value for valid key and index', () => {
        const periods = [{ year: 2023, type: 'fact', label: "Test" }];
        const data = generatePeriodData(periods, 1);
        const value = getMetricValue(data, METRIC_KEYS.OPERATION_INCOME, 0);
        assertTrue(value > 0);
      });

      it('returns 0 for invalid index', () => {
        const periods = [{ year: 2023, type: 'fact', label: "Test" }];
        const data = generatePeriodData(periods, 1);
        assertEqual(getMetricValue(data, METRIC_KEYS.OPERATION_INCOME, 99), 0);
      });

      it('returns 0 for null data', () => {
        assertEqual(getMetricValue(null, METRIC_KEYS.OPERATION_INCOME, 0), 0);
      });
    });

    describe('calculateDelta', () => {
      it('calculates positive delta', () => {
        assertEqual(calculateDelta(110, 100), 10);
      });

      it('calculates negative delta', () => {
        assertEqual(calculateDelta(90, 100), -10);
      });

      it('calculates zero delta for same values', () => {
        assertEqual(calculateDelta(100, 100), 0);
      });

      it('handles zero previous value', () => {
        assertEqual(calculateDelta(100, 0), 100);
        assertEqual(calculateDelta(0, 0), 0);
      });
    });

    describe('generateChartData', () => {
      it('generates chart data from period data', () => {
        const periods = [
          { year: 2023, type: 'fact', label: "Факт '23" },
          { year: 2024, type: 'plan', label: "План '24" }
        ];
        const data = generatePeriodData(periods, 1);
        const chartData = generateChartData(data, METRIC_KEYS.INVESTMENT_DIVIDENDS);

        assertEqual(chartData.length, 2);
        assertEqual(chartData[0].label, "Факт '23");
        assertEqual(chartData[0].type, 'fact');
        assertEqual(chartData[1].type, 'plan');
      });

      it('uses absolute values for chart', () => {
        const periods = [{ year: 2023, type: 'fact', label: "Test" }];
        const data = generatePeriodData(periods, 1);
        // INVESTMENT_DIVIDENDS is negative in base values
        const chartData = generateChartData(data, METRIC_KEYS.INVESTMENT_DIVIDENDS);
        assertTrue(chartData[0].value > 0);
      });
    });

    describe('getFundMultiplier', () => {
      it('returns correct multiplier for known fund', () => {
        assertEqual(getFundMultiplier('ДВН'), 1.0);
      });

      it('returns 1.0 for unknown fund', () => {
        assertEqual(getFundMultiplier('UNKNOWN'), 1.0);
      });
    });

    // ========================================
    // dom.js tests
    // ========================================
    describe('createElement', () => {
      it('creates element with tag', () => {
        const el = createElement('div');
        assertEqual(el.tagName, 'DIV');
      });

      it('creates element with class', () => {
        const el = createElement('div', 'test-class');
        assertTrue(el.classList.contains('test-class'));
      });

      it('creates element with array of classes', () => {
        const el = createElement('div', ['class1', 'class2']);
        assertTrue(el.classList.contains('class1'));
        assertTrue(el.classList.contains('class2'));
      });

      it('creates element with text content', () => {
        const el = createElement('span', '', 'Hello');
        assertEqual(el.textContent, 'Hello');
      });

      it('creates element with child element', () => {
        const child = createElement('span', '', 'Child');
        const parent = createElement('div', '', child);
        assertEqual(parent.children.length, 1);
        assertEqual(parent.children[0].textContent, 'Child');
      });

      it('creates element with attributes', () => {
        const el = createElement('input', '', '', { type: 'text', placeholder: 'Test' });
        assertEqual(el.getAttribute('type'), 'text');
        assertEqual(el.getAttribute('placeholder'), 'Test');
      });

      it('creates element with data attributes', () => {
        const el = createElement('div', '', '', { data: { id: '123', name: 'test' } });
        assertEqual(el.dataset.id, '123');
        assertEqual(el.dataset.name, 'test');
      });
    });

    describe('createSVGElement', () => {
      it('creates SVG element', () => {
        const el = createSVGElement('rect', { x: 10, y: 20, width: 100, height: 50 });
        assertEqual(el.tagName, 'rect');
        assertEqual(el.getAttribute('x'), '10');
        assertEqual(el.getAttribute('width'), '100');
      });

      it('creates SVG element with class', () => {
        const el = createSVGElement('g', { class: 'test-group' });
        assertEqual(el.getAttribute('class'), 'test-group');
      });
    });

    describe('createSVG', () => {
      it('creates SVG container with viewBox', () => {
        const svg = createSVG(350, 500, 'chart');
        assertEqual(svg.getAttribute('viewBox'), '0 0 350 500');
        assertEqual(svg.getAttribute('class'), 'chart');
      });
    });

    describe('createSVGText', () => {
      it('creates text element with content', () => {
        const text = createSVGText('Hello', 100, 50);
        assertEqual(text.textContent, 'Hello');
        assertEqual(text.getAttribute('x'), '100');
        assertEqual(text.getAttribute('y'), '50');
      });
    });

    describe('createSVGRect', () => {
      it('creates rect element', () => {
        const rect = createSVGRect(10, 20, 100, 50, { fill: '#9DBCE0', rx: 5 });
        assertEqual(rect.getAttribute('x'), '10');
        assertEqual(rect.getAttribute('y'), '20');
        assertEqual(rect.getAttribute('width'), '100');
        assertEqual(rect.getAttribute('height'), '50');
        assertEqual(rect.getAttribute('fill'), '#9DBCE0');
        assertEqual(rect.getAttribute('rx'), '5');
      });
    });

    describe('createSVGLine', () => {
      it('creates line element', () => {
        const line = createSVGLine(0, 50, 300, 50, { stroke: '#ccc' });
        assertEqual(line.getAttribute('x1'), '0');
        assertEqual(line.getAttribute('y1'), '50');
        assertEqual(line.getAttribute('x2'), '300');
        assertEqual(line.getAttribute('y2'), '50');
        assertEqual(line.getAttribute('stroke'), '#ccc');
      });
    });

    describe('clearElement', () => {
      it('removes all children', () => {
        const parent = createElement('div', '', [
          createElement('span'),
          createElement('span'),
          createElement('span')
        ]);
        assertEqual(parent.children.length, 3);
        clearElement(parent);
        assertEqual(parent.children.length, 0);
      });
    });

    describe('toggleClass', () => {
      it('toggles class on element', () => {
        const el = createElement('div');
        toggleClass(el, 'active');
        assertTrue(el.classList.contains('active'));
        toggleClass(el, 'active');
        assertFalse(el.classList.contains('active'));
      });

      it('forces class add', () => {
        const el = createElement('div');
        toggleClass(el, 'active', true);
        assertTrue(el.classList.contains('active'));
        toggleClass(el, 'active', true);
        assertTrue(el.classList.contains('active'));
      });

      it('forces class remove', () => {
        const el = createElement('div', 'active');
        toggleClass(el, 'active', false);
        assertFalse(el.classList.contains('active'));
      });
    });

    describe('hasClass', () => {
      it('returns true if element has class', () => {
        const el = createElement('div', 'test-class');
        assertTrue(hasClass(el, 'test-class'));
      });

      it('returns false if element does not have class', () => {
        const el = createElement('div', 'other-class');
        assertFalse(hasClass(el, 'test-class'));
      });
    });

    // Run tests
    renderResults();
  </script>
</body>
</html>
